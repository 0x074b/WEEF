# fodhelper.exe
## What is it?
*```fodhelper.exe``` is a Windows executable related to the **"Features on Demand"** functionality, which allows users to add or remove certain Windows features without needing to perform a full installation. It is typically used in enterprise environments to manage optional features of Windows installations.*

*The file is part of the system and located in the ```C:\Windows\System32``` folder. While it is not generally recognized as a malicious executable, it can be exploited by attackers due to its trusted status and the fact that it is a system process.*

## Legitimate Usage
- **Add or Remove Windows Features** → Allows users to manage optional Windows features such as Hyper-V, .NET Framework, or others without needing a full reinstall.
- **Windows Update** → Used in the process of updating or enabling specific components or services within Windows.
- **Manage Optional System Components** → Enables users to add or remove system components that are not initially installed during Windows setup, often used in enterprise environments to tailor system configurations.

## How to abuse it
- **Evasion via Trusted System Process** → Attackers can use ```fodhelper.exe``` to execute malicious payloads, exploiting its legitimate status to avoid detection by security tools.
- **Privilege Escalation** → Attackers can use ```fodhelper.exe``` to manipulate Windows features or execute high-level commands with elevated privileges, especially if it is executed with administrator rights.
- **Persistence** → Attackers may manipulate system features or configuration settings, using ```fodhelper.exe``` to enable or disable security features, thus ensuring the persistence of their malicious activities.
- **Lateral Movement** → By exploiting this executable, attackers may initiate remote processes or connect to other systems, aiding lateral movement within an enterprise network.

## Example attacks
### 1. Privilege Escalation via Windows Features
*Attackers can use ```fodhelper.exe``` to enable or disable features that grant elevated privileges, such as enabling remote desktop or installing vulnerable components.*

**Enable Remote Desktop for Lateral Movement**

```
fodhelper.exe /EnableRemoteDesktop
```

**Effect:**
- Enables **Remote Desktop** on the target machine, allowing attackers to connect remotely and potentially escalate privileges or move laterally.

### 2. Exploiting Features on Demand for Malicious Execution
*Attackers can use ```fodhelper.exe``` to enable or disable specific features of Windows, potentially enabling backdoor access or removing security features.*

**Disable Windows Defender Using Features on Demand**

```
fodhelper.exe /DisableWindowsDefender
```

**Effect:**
- Disables **Windows Defender** or other security features to reduce the chances of detection or automatic defense against malicious activities.

### 3. Persistence by Enabling Unnecessary Components
*Attackers may use ```fodhelper.exe``` to enable unnecessary or vulnerable components, which can be exploited for persistence or further exploitation.*

**Enable Legacy Features to Bypass Security Controls**

```
fodhelper.exe /EnableLegacyFeatures
```

**Effect:**
- Enables deprecated or vulnerable Windows components that might be susceptible to exploitation, providing attackers with additional persistence mechanisms or attack vectors.

### 4. Using FODHelper to Load Malicious Payloads
*Attackers can exploit ```fodhelper.exe``` to load and execute malicious payloads by tricking the system into thinking the payload is a legitimate feature.*

**Load a Malicious Payload via Features on Demand**

```
fodhelper.exe /InstallMaliciousPayload
```

**Effect:**
- Installs a malicious payload disguised as a legitimate Windows feature, making it harder for security tools to detect the attack.

### 5. Bypassing UAC Using FODHelper
*Attackers can use ```fodhelper.exe``` to bypass User Account Control (UAC) by leveraging it to launch system-level commands without triggering UAC prompts.*

**Bypass UAC with FODHelper**

```
fodhelper.exe /LaunchWithElevatedPrivileges
```

**Effect:**
- Executes commands or payloads with **elevated privileges**, bypassing UAC prompts typically used to protect against unauthorized system changes.

# Detection & Mitigation
## Detection Methods
**Monitor Usage of fodhelper.exe**
- **Event ID 4688 (Process Creation)** → Track when ```fodhelper.exe``` is executed, especially if it is run by non-administrative users or with unusual arguments.
- **Behavioral Analysis** → Look for patterns of unusual system configuration changes or feature manipulations initiated by ```fodhelper.exe```.

**Monitor Elevated Privileges**
- **Event ID 4672 (Special Privileges Assigned to New Logon)** → Track when users gain special privileges, particularly when associated with the use of system utilities like ```fodhelper.exe```.

## Mitigation Strategies
- **Restrict Execution of fodhelper.exe** → Use application control tools (like AppLocker or WDAC) to restrict unauthorized use of ```fodhelper.exe```, particularly for non-administrative users.
- **Monitor System Configuration Changes** → Track changes to system features, especially those related to security features, to detect malicious modifications.
- **Implement Least Privilege Access** → Limit the ability to enable or disable critical system features to only trusted and authorized administrators.
- **Enforce UAC** → Ensure User Account Control (UAC) is properly configured and prevent bypass techniques from succeeding.
