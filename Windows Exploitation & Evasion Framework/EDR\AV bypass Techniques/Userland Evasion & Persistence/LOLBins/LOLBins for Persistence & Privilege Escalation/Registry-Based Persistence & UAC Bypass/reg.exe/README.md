# reg.exe
## What is it?
*```reg.exe``` is a **built-in Windows command-line utility** that allows users to manage the Windows registry. It can be used to view, add, modify, or delete registry keys and values from the command prompt.*

*Since it is a trusted system tool, security software may overlook its use, making it a valuable tool for attackers to persist, hide traces, or manipulate system configurations.*

## Legitimate Usage
- **Registry Configuration** → Modify system settings, such as hardware configurations, software settings, or user preferences.
- **Backup & Restore Registry** → Use ```reg.exe``` to export and import registry files for backup or recovery purposes.
- **Scripted Configuration Changes** → Apply registry changes in automated scripts or during the deployment of software.
- **Software Installation & Configuration** → Set application-specific registry values needed for proper functionality.

## How to abuse it
- **Persistence** → Attackers can add malicious registry keys to ensure that their payloads are executed at startup or after specific events.
- **Bypassing Security Controls** → Attackers can modify security-related registry values, such as UAC settings or AppLocker policies, to bypass detection or restrictions.
- **Hiding Malicious Activities** → Malicious users can delete or alter registry keys associated with security software or logging to avoid detection.
- **Privilege Escalation** → Modify registry values that control user permissions or elevate privileges to execute malicious code with higher privileges.

## Example attacks
### 1. Persistence via Registry Key Creation
*Attackers can create a registry entry in the `HKCU\Software\Microsoft\Windows\CurrentVersion\Run` location, ensuring that their malware runs every time the user logs in.*

**Add Malicious Registry Key for Startup**

```
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v "Malware" /t REG_SZ /d "C:\path\to\malware.exe" /f
```

**Effect:**
- Adds the malicious executable to the **Startup** registry key, ensuring persistence across reboots.

### 2. Disabling Windows Defender via Registry Modification
*```reg.exe``` can be used to modify registry values that disable Windows Defender or alter its settings, allowing malware to operate undetected.*

**Disable Windows Defender Antivirus**

```
reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows Defender" /v "DisableAntiSpyware" /t REG_DWORD /d 1 /f
```

**Effect:**
- Disables Windows Defender, making it easier for malicious software to run without interference.

### 3. Elevating Privileges via Registry Manipulation
*Attackers can use ```reg.exe``` to modify registry settings that control user rights and permissions, allowing privilege escalation.*

**Modify Registry for Privilege Escalation**

```
reg add "HKCU\Software\Microsoft\Windows NT\CurrentVersion\Winlogon" /v "Userinit" /t REG_SZ /d "C:\Windows\System32\cmd.exe" /f
```

**Effect:**
- Changes the **Userinit** registry key, causing the system to run ```cmd.exe``` on startup, which can be used for privilege escalation.

### 4. Hiding Malicious Files via Registry Key Removal
*By deleting registry keys associated with security software or logging, attackers can hide their tracks and avoid detection.*

**Remove Registry Keys for Evasion**

```
reg delete "HKLM\SOFTWARE\Microsoft\Windows Defender" /f
```

**Effect:**
- Removes registry entries related to Windows Defender, making it harder for the system to detect malicious activity.

### 5. Bypassing UAC via Registry Changes
*```reg.exe``` can modify registry keys related to **User Account Control (UAC)**, which may help bypass administrative restrictions.*

**Lower UAC Security Level**

```
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Policies\System" /v "EnableLUA" /t REG_DWORD /d 0 /f
```

**Effect:**
- Disables **UAC** (User Account Control), allowing malicious programs to run with elevated privileges without triggering security prompts.

# Detection & Mitigation
## Detection Methods
**Monitor Registry Changes**
- **Event ID 4657 (Registry Value Modified)** → Detect suspicious registry modifications, especially those that involve security-related keys.
- **Watch for Malicious Registry Paths** → Monitor common persistence paths, such as **HKCU\Software\Microsoft\Windows\CurrentVersion\Run** and **HKLM\Software\Microsoft\Windows\CurrentVersion\Run**.
- **Look for Disabling of Security Controls** → Watch for changes to registry entries that disable antivirus software, Windows Defender, or UAC.

**Monitor Execution of ```reg.exe```**
- **Event ID 4688 (Process Creation)** → Monitor the execution of **reg.exe** for unexpected or unauthorized registry modifications.
- **Behavioral Analysis** → Look for command-line arguments that manipulate security settings or persistence-related registry keys.

## Mitigation Strategies
- **Restrict Access to ```reg.exe```** → Use application whitelisting (AppLocker, WDAC) to limit the execution of **reg.exe** to authorized users and administrators only.
- **Monitor & Audit Registry Changes** → Regularly audit registry changes, particularly for suspicious modifications related to startup processes or security settings.
- **Implement User Account Control (UAC)** → Enforce UAC settings to ensure that unauthorized changes to critical registry values cannot be made without administrative approval.
- **Use Endpoint Detection and Response (EDR)** → Deploy EDR tools that monitor for suspicious behavior, such as unexpected registry modifications or the execution of **reg.exe** with abnormal arguments.
