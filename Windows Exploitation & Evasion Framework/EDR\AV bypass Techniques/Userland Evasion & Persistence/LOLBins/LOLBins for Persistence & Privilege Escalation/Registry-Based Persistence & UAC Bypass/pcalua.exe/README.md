# pcalua.exe
## What is it?
*```pcalua.exe``` (Program Compatibility Assistant UAC Launcher) is a **Windows system binary** designed to help run older applications that require administrative privileges.*  
*It interacts with User Account Control (UAC) to ensure legacy software functions properly on modern Windows versions.*

*Because it's a **trusted**, **built-in Windows binary**, security tools often **overlook its misuse**.*

## Legitimate Usage
- **Run Legacy Applications** → Ensures older programs run correctly on modern Windows.
- **Launch Installers with UAC Prompt** → Helps install software requiring admin rights.
- **Compatibility Fixes** → Allows applications to operate in compatibility mode.

## How to abuse it
- **UAC Bypass** → Execute programs with **higher privileges** without triggering UAC prompts.
- **Execution Hijacking** → Use ```pcalua.exe``` to launch **malicious payloads** instead of legitimate apps.
- **Whitelisting Bypass** → Evade security solutions by using a **trusted Microsoft binary**.

## Example Attacks
### 1. UAC Bypass via Registry Hijacking
*Attackers can manipulate the registry so that ```pcalua.exe``` launches **malicious payloads** instead of legitimate programs.*

**Modify Registry to Hijack Execution**
```
reg add "HKCU\Software\Classes\exefile\shell\runas\command" /ve /t REG_SZ /d "C:\Malicious.exe" /f pcalua.exe -a C:\Windows\System32\calc.exe
```
**Effect:**
- Any program requiring **UAC elevation** now runs ```C:\Malicious.exe``` instead.
- No UAC prompt is displayed, executing the attacker's payload **silently**.

### 2. Running a Fake Installer with Elevated Privileges
*Attackers can disguise malware as an installer and execute it with ```pcalua.exe```.*  

**Run Malware as an Elevated Installer**
```
pcalua.exe -a C:\MaliciousInstaller.exe
```
**Effect:**
- The system **trusts ```pcalua.exe```**, allowing it to **bypass security restrictions**.
- The attacker’s installer executes **with admin rights**.

### 3. DLL Hijacking for Execution Hijacking
*Attackers can place a **malicious DLL** in a **trusted location** so that ```pcalua.exe``` loads it instead of the real DLL.*

**Drop Malicious DLL in a Vulnerable Path**
```
copy C:\Malicious.dll C:\Program Files\VulnerableApp\malicious.dll pcalua.exe -a "C:\Program Files\VulnerableApp\app.exe"
```
**Effect:**
- When ```pcalua.exe``` launches ```app.exe```, it **loads ```malicious.dll``` instead of the real DLL**.
- The attacker's **malicious code executes with elevated privileges**.

### 4. Persistence via Scheduled Tasks
*Attackers can use ```pcalua.exe``` to **schedule persistent execution of malicious payloads**.*

**Create a Scheduled Task That Uses ```pcalua.exe```**
```
schtasks /create /tn "UpdateTask" /tr "pcalua.exe -a C:\Malicious.exe" /sc onlogon /ru SYSTEM
```
*Ensures ```C:\Malicious.exe``` runs **on every system startup** with elevated privileges.*

## Detection & Mitigation
### Detection Methods
**Monitor Registry Modifications**
- **Event ID 4657 (Registry Value Change)** → Detects changes to ```exefile\shell\runas\command```.

**Detect Suspicious ```pcalua.exe``` Execution**
- **Event ID 4688 (Process Creation)** → Detects ```pcalua.exe``` launching non-standard files.

**Monitor DLL Injection Attempts**
- **Sysmon Event ID 7** → Detects unauthorized DLL loads.

### Mitigation Strategies
- **Restrict Registry Editing** → Prevent unauthorized changes to ```exefile\shell\runas\command```.
- **Use Application Control (AppLocker, WDAC)** → Block unauthorized execution of ```pcalua.exe```.
- **Monitor and Restrict Execution of ```pcalua.exe```** → Detect abnormal usage patterns.
