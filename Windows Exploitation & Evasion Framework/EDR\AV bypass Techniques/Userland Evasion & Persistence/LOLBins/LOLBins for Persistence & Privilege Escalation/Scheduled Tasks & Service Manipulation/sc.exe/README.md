# sc.exe
## What is it?
*```sc.exe``` (Service Control) is a built-in Windows command-line tool used for managing Windows services. It allows users to **create, modify, start, stop, delete, and query services** on local and remote systems.*

*Because it's a **trusted system utility**, attackers frequently abuse ```sc.exe``` to **install persistence mechanisms**, **escalate privileges**, and **execute malicious payloads** while bypassing security controls.*

## Legitimate Usage
- **Service Management** → Start, stop, or modify Windows services.
- **Troubleshooting & Diagnostics** → Query service status and configurations.
- **Remote Administration** → Manage services on remote machines via **SC \\<remote_host>**.
- **Automated Task Execution** → Use in scripts to control services programmatically.

## How to abuse it
- **Persistence via Malicious Services** → Attackers create or modify services to maintain access.
- **Privilege Escalation** → Exploiting misconfigured services to gain SYSTEM privileges.
- **Remote Code Execution** → Executing malicious payloads via remote service control.
- **Defense Evasion** → Using trusted ```sc.exe``` to blend in with legitimate system activity.

## Example attacks
### 1. Creating a Malicious Service for Persistence
*Attackers create a service that runs their malware on startup.*

**Create a Service that Executes Malware**

```
sc create EvilService binPath= "C:\Windows\System32\cmd.exe /c C:\malware.exe" start= auto
```

**Effect:**
- **Creates a new Windows service** named **EvilService**.
- **Executes malware.exe** every time the system boots.
- **Starts automatically**, ensuring persistence.

### 2. Running a Command as SYSTEM
*Attackers can use ```sc.exe``` to run commands with **SYSTEM privileges**.*

**Start a SYSTEM Shell**

```
sc start TrustedInstaller sc config TrustedInstaller binPath= "C:\Windows\System32\cmd.exe /k whoami"
```

**Effect:**
- **Runs a SYSTEM-level command shell**, bypassing UAC restrictions.
- **Executes commands with elevated privileges**.

### 3. Stopping Security Services
*Attackers disable security mechanisms by stopping Windows Defender or EDR services.*

**Disable Windows Defender**

```
sc stop WinDefend sc config WinDefend start= disabled
```

**Effect:**
- **Stops Windows Defender**, leaving the system unprotected.
- **Disables Defender from restarting**.

### 4. Remote Code Execution via Service Creation
*Attackers can create services on remote machines to execute payloads.*

**Execute Malware Remotely**

```
sc \192.168.1.50 create RemoteService binPath= "C:\malware.exe" start= auto sc \192.168.1.50 start RemoteService
```

**Effect:**
- **Pushes and executes malware** on a remote system.
- **Uses legitimate service creation to evade detection**.

### 5. Abusing Unquoted Service Paths for Privilege Escalation
*If a service has an unquoted path vulnerability, attackers can exploit it to execute malware.*

**Example of a Vulnerable Service Path**

```
C:\Program Files\SomeApp\My Service.exe
```

**Exploit:**
1. **Drop a malicious executable** named ```My.exe``` in ```C:\Program Files\SomeApp\```.
2. **Restart the service**, causing Windows to execute ```My.exe``` with SYSTEM privileges.

# Detection & Mitigation
## Detection Methods
**Monitor Service Modifications**
- **Event ID 4697 (New Service Installed)** → Detect suspicious service creations.
- **Event ID 7045 (Service Installation)** → Look for unauthorized services.

**Detect Unusual Service Execution**
- **Event ID 7036 (Service State Change)** → Monitor unexpected service starts or stops.
- **Look for Suspicious Service Names** → Random or obfuscated service names may indicate malware.

**Detect Remote Service Manipulation**
- **Monitor for ```sc.exe``` Executions with Remote Hosts** (e.g., ```sc \\192.168.1.50```).

## Mitigation Strategies
- **Restrict Service Creation Permissions** → Limit who can create or modify services.
- **Monitor & Block Unauthorized Service Changes** → Use security tools to detect abnormal service modifications.
- **Use AppLocker or WDAC** → Prevent execution of unauthorized binaries via Windows services.
- **Harden High-Privilege Services** → Ensure services run with the **least privilege necessary**.
