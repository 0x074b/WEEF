# schtasks.exe  
## What is it?  
*```schtasks.exe``` is a **built-in Windows command-line utility** used to **schedule and manage tasks**.*  
*It allows users to create, delete, and modify scheduled tasks, automating processes such as software updates and system maintenance.*  
*Because it is a **trusted system binary**, attackers often abuse it for **persistence, privilege escalation, and execution of malicious payloads**.*  

## Legitimate Usage  
- **Automating System Maintenance** → Schedule periodic disk cleanup, updates, and backups.  
- **Running Scripts on a Schedule** → Automate PowerShell scripts and batch jobs.  
- **Delayed or Recurring Task Execution** → Run programs at boot, logon, or at specific intervals.  

## How to abuse it  
- **Persistence** → Create a scheduled task that executes malware at startup.  
- **Privilege Escalation** → Run tasks as SYSTEM or another high-privilege user.  
- **Lateral Movement** → Deploy tasks on remote systems for execution.  
- **Execution of Malicious Code** → Run scripts or payloads bypassing security tools.  

## Example Attacks  
### 1. Persistence via Scheduled Task  
*Attackers create a task that runs malware at startup.*  

```
schtasks /create /tn "Windows Update" /tr "C:\Malware\payload.exe" /sc onlogon /ru SYSTEM
```

**Effect:**  
- Runs `payload.exe` **every time a user logs in**.  
- Executes with **SYSTEM privileges**.  

### 2. Delayed Execution for Evasion  
*Attackers schedule a delayed execution to bypass real-time monitoring.*  

```
schtasks /create /tn "DelayedExecution" /tr "C:\Malware\payload.exe" /sc once /st 12:00 /ru SYSTEM
```

**Effect:**  
- Delays execution of `payload.exe` until a specific time.  
- Helps evade **sandbox detection and forensic analysis**.  

### 3. Running a Malicious Command as SYSTEM  
*Attackers can execute arbitrary commands with high privileges.*  

```
schtasks /create /tn "SystemCheck" /tr "cmd.exe /c whoami > C:\Users\Public\output.txt" /sc once /st 00:01 /ru SYSTEM
```

**Effect:**  
- Runs `whoami` with SYSTEM privileges, writing output to a file.  
- Can be replaced with **malicious commands** for privilege escalation.  

### 4. Remote Execution (Lateral Movement)  
*Attackers use scheduled tasks to execute payloads on remote machines.*  

```
schtasks /create /s 192.168.1.50 /u admin /p password /tn "RemoteTask" /tr "C:\Malware\payload.exe" /sc once /st 00:01
```

**Effect:**  
- Runs `payload.exe` **on a remote machine** (192.168.1.50).  
- Requires admin credentials for execution.  

### 5. Hiding Malicious Tasks  
*Attackers create hidden tasks that do not appear in Task Scheduler UI.*  

```
schtasks /create /tn "HiddenTask" /tr "C:\Malware\payload.exe" /sc onlogon /f /ru SYSTEM /it
```

**Effect:**  
- Runs silently, avoiding detection in Task Scheduler.  
- Can be used for **stealthy persistence**.  

## Detection & Mitigation  
### Detection Methods  
- **Monitor Scheduled Task Creation** → Look for `Event ID 4698 (Task Created)`.  
- **Detect Unexpected System Tasks** → Regularly audit `schtasks.exe` execution.  
- **Track Remote Task Creation** → Monitor for remote task creation via `Event ID 5140`.  

### Mitigation Strategies  
- **Restrict Scheduled Task Creation** → Limit usage to trusted users.  
- **Monitor for Unauthorized Execution** → Detect tasks executing from unusual locations.  
- **Disable Remote Task Execution** → Prevent attackers from scheduling tasks on remote machines.  
