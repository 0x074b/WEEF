# msiexec.exe
## What is it?
*```msiexec.exe``` is the Windows Installer executable, used to install, modify, and remove software packages (.msi files) on a Windows operating system. It is part of the Windows Installer service, which provides a standardized interface for managing the installation and uninstallation of applications.*

*While it is a legitimate tool used by system administrators and software developers to deploy and manage applications, it can also be abused by attackers to install malicious software and bypass security controls.*

## Legitimate Usage
- **Software Installation & Management** → Install, modify, or uninstall software packages.
- **Silent Installations** → Automate the installation process with silent switches (e.g., ```/quiet``` or ```/qn```), which suppress user prompts.
- **Patch Management** → Apply patches or updates to existing software installations.
- **Configuration & Customization** → Customize installations by using command-line arguments to specify installation options or target directories.

## How to abuse it
- **Malware Installation** → Attackers can use ```msiexec.exe``` to install malicious software from a malicious MSI file.
- **Bypassing Security Controls** → Attackers may abuse trusted system processes like ```msiexec.exe``` to execute payloads, bypassing whitelisting or security software.
- **Persistence via MSI Packages** → Malicious MSI packages can be deployed to install backdoors or other malware persistently on the system.
- **Privilege Escalation** → Attackers can exploit vulnerabilities in MSI packages or the Windows Installer service to escalate privileges and gain elevated access.

## Example attacks
### 1. Installing Malicious Software via MSI Package
*Attackers can use ```msiexec.exe``` to install a malicious package that contains a payload or malware.*

**Install Malicious Software Silently**

```
msiexec.exe /i "malware.msi" /quiet /norestart
```

**Effect:**
- **```/i```** → Specifies the MSI package to install.
- **```/quiet```** → Runs the installation without any user prompts.
- **```/norestart```** → Prevents the system from restarting after installation.
- The attacker installs a malicious payload without user intervention or detection.

### 2. Bypassing Security Controls with MSI Package
*Because ```msiexec.exe``` is a trusted Windows binary, it may bypass application whitelisting or endpoint protection tools.*

**Run Malicious Script via MSI Package**

```
msiexec.exe /i "malicious_script.msi" /quiet /norestart
```

**Effect:**
- Malicious scripts or executables inside the MSI package are executed, bypassing security software that may have flagged the script itself.
- The attack is executed without triggering any visible prompts or alerts.

### 3. Persistence via MSI Package
*Attackers can create a persistent backdoor by packaging a malicious payload in an MSI file that installs a malicious service or modifies system settings.*

**Deploy Malicious MSI Package for Persistence**

```
msiexec.exe /i "persistence.msi" /quiet /norestart
```

**Effect:**
- The MSI package installs a persistent backdoor, which survives reboots and can automatically reconnect to an attacker’s C2 server or provide continuous access.
- Ensures that the backdoor remains active even after the system is rebooted.

### 4. Exploiting MSI Package Vulnerabilities for Privilege Escalation
*If an attacker can exploit a vulnerability in the MSI package, they can gain elevated privileges or control over the system.*

**Exploit Vulnerability in MSI Package**

```
msiexec.exe /i "privilege_escalation.msi" /quiet /norestart
```

**Effect:**
- The attacker exploits a vulnerability in the MSI installation process (such as insecure file permissions or DLL hijacking) to escalate privileges or gain system-level access.

### 5. Exfiltrating Data via MSI Package
*Attackers can use ```msiexec.exe``` to deploy an MSI package that includes a tool to exfiltrate data.*

**Exfiltrate Data Using MSI Package**

```
msiexec.exe /i "data_exfiltration.msi" /quiet /norestart
```

**Effect:**
- The MSI package contains a tool or script that retrieves sensitive data from the target machine and sends it to the attacker’s server.
- Allows for data theft without the user noticing any prompts or alerts.

# Detection & Mitigation
## Detection Methods
**Monitor MSI Package Executions**
- **Event ID 4688 (Process Creation)** → Watch for the execution of ```msiexec.exe``` and check for unusual command-line arguments (such as ```/quiet``` or ```/i``` pointing to suspicious files).
- **File Integrity Checks** → Detect if an MSI package has been tampered with or is coming from an untrusted source.

**Monitor for Suspicious Package Installations**
- **Event ID 3010 (Windows Installer Event)** → Detect the installation of MSI packages that may be executed without user consent or involvement.
- **Look for unusual installations** in sensitive system directories or new programs installed during non-standard hours.

**Watch for Persistence Indicators**
- **Scheduled Task Creation** → Monitor for the creation of scheduled tasks that might run ```msiexec.exe``` at regular intervals.
- **File Creation or Modification** → Check for the creation or modification of files associated with known malware (e.g., executables, services, or scripts) in the installation directory.

## Mitigation Strategies
- **Use Application Control** → Implement Application Whitelisting (e.g., AppLocker or WDAC) to prevent unauthorized execution of ```msiexec.exe``` or MSI files.
- **Monitor System and Application Logs** → Regularly monitor the Event Viewer for suspicious activity or unusual installations that could indicate malicious use of ```msiexec.exe```.
- **Restrict User Permissions** → Limit who can execute MSI packages or who can install software by restricting administrative access.
- **Validate and Scan MSI Packages** → Ensure that all MSI files are scanned for malware before installation, especially from untrusted or unknown sources.
