# dism.exe
## What is it?
*```dism.exe``` (Deployment Imaging Service and Management Tool) is a command-line tool used by administrators for servicing and preparing Windows images. It allows for operations such as installing, uninstalling, configuring, and updating Windows features and packages.*

*Though it is a legitimate tool used for system administration and deployment, ```dism.exe``` can also be abused by attackers to tamper with system images or disable security features.*

## Legitimate Usage
- **Image Management** → Deploy, update, or repair Windows system images.
- **Feature & Package Management** → Add or remove Windows features and packages (e.g., Windows Updates or language packs).
- **System Health & Maintenance** → Repair and service system files and components, such as through the use of ```/restorehealth``` for fixing system corruption.
- **Offline Servicing** → Apply changes to Windows images offline, such as adding drivers or updates before deployment.

## How to abuse it
- **Disabling Security Features** → Attackers can use ```dism.exe``` to disable or remove security features like Windows Defender, firewalls, or Windows Update, allowing for the persistence of malicious software.
- **Tampering with System Images** → Attackers can modify system images to deploy malware or backdoors that are triggered during system boot or when a user logs in.
- **Bypassing Security Mechanisms** → Modify the system image to add new user accounts with escalated privileges or disable certain user rights and privileges.
- **Data Exfiltration via Image Modification** → By modifying the system image, attackers could exfiltrate data or ensure that the data is included in the deployed image for later retrieval.

## Example attacks
### 1. Disabling Windows Defender
*Attackers can disable Windows Defender using ```dism.exe``` to allow for easier malware execution.*

**Disable Windows Defender with DISM**

```
dism.exe /online /disable-feature /featurename:Windows-Defender-Features /norestart
```

**Effect:**
- Disables Windows Defender, making the system vulnerable to malware without being detected by security software.

### 2. Adding a Backdoor via System Image
*By adding a malicious user account to the system image, attackers can ensure that the backdoor account is present when the system is deployed or reset.*

**Create a New User Account with Admin Privileges**

```
dism.exe /image:C:\mount /add-package /packagepath:"C:\path\to\backdoor.msu"
```

**Effect:**
- Adds a malicious package to the image that includes a new user account with admin privileges, allowing attackers to maintain access to the system.

### 3. Modify System Features to Disable Security Mechanisms
*Attackers can modify system features or settings via ```dism.exe``` to disable features like firewalls or Windows updates.*

**Disable Windows Firewall**

```
dism.exe /online /disable-feature /featurename:Windows-Firewall /norestart
```

**Effect:**
- Disables Windows Firewall, which could be exploited by attackers to carry out attacks without being blocked by network security controls.

### 4. Deploy Malicious Software During System Imaging
*Attackers can inject malicious software into the system image during the deployment phase.*

**Inject Malicious Software into Windows Image**

```
dism.exe /image:C:\mount /add-package /packagepath:"C:\path\to\malware.msu"
```

**Effect:**
- Malicious software is deployed along with the system image, ensuring persistence every time the system is installed or reset.

### 5. Data Exfiltration via System Image Modification
*Attackers can modify system images to include files they wish to exfiltrate, such as sensitive documents or payloads.*

**Inject Sensitive Data into the System Image**

```
dism.exe /image:C:\mount /add-package /packagepath:"C:\path\to\sensitive_data.msu"
```

**Effect:**
- Sensitive files are injected into the image and can be retrieved once the image is deployed on a new system.

# Detection & Mitigation
## Detection Methods
**Monitor DISM Usage**
- **Event ID 4688 (Process Creation)** → Watch for execution of ```dism.exe``` and review the command-line arguments used to detect suspicious activities, such as disabling security features.
- **Command-line Analysis** → Investigate the use of ```/disable-feature``` and ```/add-package``` options, which could be used for unauthorized actions.

**Check for System Image Changes**
- **Verify Package Integrity** → Regularly check for the integrity of system images, and ensure no unauthorized packages have been added.
- **Monitor for Unusual Feature Modifications** → Look for unusual system feature changes that could indicate an attack, such as disabled security features or new unauthorized user accounts.

## Mitigation Strategies
- **Limit Administrative Access to DISM** → Restrict access to ```dism.exe``` to only trusted administrators. Use least-privilege access principles to minimize the attack surface.
- **Enable Windows Defender and Other Security Features** → Ensure that security features like Windows Defender and firewalls are enabled and cannot be disabled through DISM.
- **Regularly Verify System Images** → Regularly audit and verify system images, especially after updates or deployments, to detect unauthorized modifications.
- **Use Application Whitelisting** → Implement application whitelisting (such as AppLocker) to prevent unauthorized execution of ```dism.exe``` or any potentially harmful scripts or tools.
