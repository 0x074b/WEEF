# runas.exe
## What is it?
*```runas.exe``` is a built-in Windows command-line tool used to run a program as a different user. It allows a user to execute a program with the credentials of another user, including administrative accounts, which is useful for system administration tasks.*

*While designed for legitimate administrative purposes, attackers can abuse ```runas.exe``` to escalate privileges or bypass security controls by executing programs with elevated or unauthorized privileges.*

## Legitimate Usage
- **Running Programs with Different User Privileges** → Execute a program as a different user without logging off or switching users (e.g., running a program as an administrator).
- **System Administration** → Use to run tools and utilities as a different user for administrative tasks.
- **Application Testing** → Run applications under different user accounts to test behavior or troubleshoot permission issues.
- **Automated Scripts** → Use in scripts to execute programs as a different user for specific system administration tasks.

## How to abuse it
- **Privilege Escalation** → Attackers can use ```runas.exe``` to execute commands or applications with higher privileges, such as SYSTEM or administrator, even if they don't have those privileges.
- **Bypassing User Access Controls (UAC)** → Attackers can bypass UAC by running programs as an administrator, circumventing the UAC prompt.
- **Lateral Movement** → Attackers can use ```runas.exe``` to run programs on remote systems with stolen credentials or a compromised user account.
- **Executing Malicious Code as an Elevated User** → Attackers can execute malicious scripts or payloads as a higher-privileged user, potentially leading to further compromise.
- **Persistence** → Attackers can use ```runas.exe``` in scheduled tasks or scripts to run their tools as high-privileged users, maintaining access to the system.

## Example attacks
### 1. Privilege Escalation
*Attackers can use ```runas.exe``` to run a program as an administrator or another higher-privileged user, bypassing security restrictions.*
**Run a Program as Administrator**

```
runas /user:Administrator "C:\path\to\program.exe"
```

**Effect:**
- Executes the program as the Administrator account, bypassing UAC and gaining higher privileges.

### 2. Bypassing UAC for Elevated Privileges
*Attackers can use ```runas.exe``` to bypass UAC and run programs with elevated privileges.*
**Run a Program with Elevated Privileges (UAC Bypass)**

```
runas /user:Administrator /savecred "C:\path\to\program.exe"
```

**Effect:**
- The `/savecred` flag stores the password for future use, allowing attackers to execute commands without triggering UAC prompts in the future.

### 3. Lateral Movement Using Stolen Credentials
*Attackers can use ```runas.exe``` with stolen user credentials to move laterally across systems.*
**Run a Program on a Remote System Using Stolen Credentials**

```
runas /user:attacker /domain:domain "C:\path\to\program.exe"
```

**Effect:**
- Executes the program on a remote system as the user ```attacker```, allowing lateral movement across the network.

### 4. Persistence via Scheduled Task with Elevated Privileges
*Attackers can schedule a task to execute a malicious program as an elevated user, maintaining persistence on the system.*
**Create a Scheduled Task to Run a Program as SYSTEM**

```
schtasks /create /tn "PersistenceJob" /tr "runas /user:SYSTEM "C:\path\to\malicious.exe"" /sc once /st 12:00
```

**Effect:**
- Creates a scheduled task to run malicious code as the SYSTEM user, ensuring persistence and elevated privileges.

### 5. Executing Malicious Code as an Elevated User
*Attackers can use ```runas.exe``` to run a malicious script or payload as an elevated user, potentially compromising the system further.*
**Run a Malicious Payload as Administrator**

```
runas /user:Administrator "C:\path\to\payload.exe"
```

**Effect:**
- Executes a malicious payload with administrator privileges, giving the attacker full control over the system.

# Detection & Mitigation
## Detection Methods
**Monitor for Elevated Execution**
- **Event ID 4688 (Process Creation)** → Monitor for process creation with ```runas.exe``` and elevated privileges (e.g., SYSTEM, Administrator).
- **Event ID 4670 (Permissions Change)** → Detect changes to permissions that may indicate an attacker is using ```runas.exe``` to execute privileged tasks.

**Detect Unusual Use of ```runas.exe```**
- **Monitor for Uncommon Executions** → Look for unusual executions of ```runas.exe``` that deviate from normal administrative tasks.
- **Analyze Command-Line Arguments** → Watch for the use of arguments like `/savecred` or unusual user accounts that could indicate an attack.

**Scheduled Task Creation**
- **Event ID 4698 (Scheduled Task Created)** → Monitor the creation of scheduled tasks, particularly those involving elevated execution.

## Mitigation Strategies
- **Restrict ```runas.exe``` Usage** → Limit access to ```runas.exe``` by only allowing trusted administrators to use it.
- **Enforce UAC** → Ensure UAC is enabled and configured to prompt for administrator credentials whenever a program requires elevated privileges.
- **Use Application Whitelisting (AppLocker)** → Prevent unauthorized execution of ```runas.exe``` with specific programs or scripts that shouldn't be run with elevated privileges.
- **Audit User Account Permissions** → Regularly audit user account privileges and ensure that users don't have unnecessary access to administrative accounts.
- **Monitor Elevated Command Usage** → Set up alerts for the use of elevated command-line tools like ```runas.exe``` to catch any suspicious activity.
