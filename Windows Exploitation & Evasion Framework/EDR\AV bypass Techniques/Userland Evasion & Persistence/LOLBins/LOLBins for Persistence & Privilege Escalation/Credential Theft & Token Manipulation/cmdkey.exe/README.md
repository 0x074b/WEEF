# cmdkey.exe
## What is it?
*```cmdkey.exe``` is a built-in Windows command-line tool used to manage stored user credentials. It allows users to create, list, and delete saved credentials for accessing remote systems or network resources. The utility is commonly used to simplify the process of accessing remote shares, servers, or websites without repeatedly entering passwords.*
*While designed for legitimate administrative tasks, it can be misused by attackers to store credentials for lateral movement or persistence.*

## Legitimate Usage
- **Managing Network Credentials** → Store credentials for accessing remote file shares or servers (e.g., network drives).
- **Accessing Remote Resources** → Use saved credentials to easily authenticate to remote resources without having to manually enter usernames and passwords.
- **Automation in Scripts** → Store and use credentials in scripts to automate administrative tasks, such as accessing remote machines or services.
- **Password Management** → Centralize and securely store credentials for various network services and devices.

## How to abuse it
- **Credential Harvesting** → Attackers can use ```cmdkey.exe``` to store stolen credentials, making it easier to move laterally across a network.
- **Persistence via Stored Credentials** → Attackers can store malicious credentials in the Windows credential manager to maintain access to systems even after the initial attack vector is closed.
- **Bypassing Security Tools** → Since ```cmdkey.exe``` is a legitimate tool, security tools may overlook its misuse, allowing attackers to stealthily store and retrieve credentials.
- **Lateral Movement** → Using stored credentials, attackers can authenticate to other machines on the network and escalate privileges.
- **Credential Dumping** → Attackers can use ```cmdkey.exe``` to extract stored credentials from the Windows Credential Manager for further exploitation.

## Example attacks
### 1. Storing Stolen Credentials for Lateral Movement
*Attackers can use ```cmdkey.exe``` to store stolen credentials and then use them to move laterally across a network.*

**Store Credentials for Lateral Movement**

```
cmdkey /add:192.168.1.50 /user:attacker /pass:password123
```

**Effect:**
- Stores the credentials for ```attacker``` with password ```password123``` for the remote system ```192.168.1.50```, allowing the attacker to easily authenticate and move laterally.

### 2. Persistence via Stored Credentials
*An attacker can use ```cmdkey.exe``` to ensure they can reconnect to a system even if the original attack vector is closed.*

**Store Malicious Credentials for Persistence**

```
cmdkey /add:remotehost /user:attacker /pass:maliciouspassword
```

**Effect:**
- The malicious credentials are stored in the system's credential manager, providing persistent access to the attacker.

### 3. Dumping Credentials from the Credential Manager
*Attackers can use ```cmdkey.exe``` to list all stored credentials, extracting them for further use.*

**List Stored Credentials**

```
cmdkey /list
```

**Effect:**
- Lists all saved credentials, which the attacker can then use for further exploitation, lateral movement, or privilege escalation.

### 4. Bypassing Security Controls by Using Stored Credentials
*By storing and retrieving credentials with ```cmdkey.exe```, attackers can bypass network security controls, such as firewalls or authentication barriers.*

**Access Remote Resource Using Stored Credentials**

```
cmdkey /list net use \192.168.1.50\C$ /user:attacker
```

**Effect:**
- Bypasses manual authentication by using the stored credentials to access remote resources like administrative shares.

### 5. Credential Dumping and Escalation
*Once credentials are stored, attackers can dump them to escalate privileges or access additional network resources.*

**Access Higher Privilege Resources Using Dumped Credentials**

```
cmdkey /list net use \192.168.1.100\C$ /user:admin
```

**Effect:**
- The attacker uses stored credentials to authenticate as an elevated user and access restricted resources.

# Detection & Mitigation
## Detection Methods
**Monitor Credential Manager Activity**
- **Event ID 4688 (Process Creation)** → Monitor for unusual creation or listing of stored credentials using ```cmdkey.exe```.
- **Event ID 5156 (Filtering Platform Connection)** → Detect abnormal network connections related to ```cmdkey.exe``` usage, indicating lateral movement or credential use.

**Detect Remote Connections**
- **Event ID 5140 (SMB Share Access)** → Look for unusual access to administrative shares from unexpected systems, which may indicate lateral movement with stolen credentials.

**Audit Credential Manager Access**
- **Audit Credential Manager Activity** → Regularly audit and review the stored credentials for any suspicious additions or changes.

## Mitigation Strategies
- **Restrict cmdkey.exe Usage** → Limit access to ```cmdkey.exe``` by restricting it to trusted administrators only.
- **Enforce Multi-Factor Authentication (MFA)** → Use MFA to prevent attackers from using stored credentials even if they manage to steal them.
- **Monitor Network Activity** → Set up monitoring for suspicious network activity, such as access to remote machines using saved credentials.
- **Disable Stored Credentials** → Configure policies to prevent the saving of credentials or limit the types of credentials that can be saved.
- **Use Endpoint Detection and Response (EDR)** → Deploy EDR solutions to monitor the use of ```cmdkey.exe``` and detect credential misuse.
