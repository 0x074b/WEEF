# certreq.exe
## What is it?
*```certreq.exe``` is a **built-in Windows command-line tool** used to request, approve, and manage digital certificates via **Active Directory Certificate Services (AD CS)**.*  
*It allows users and administrators to **generate, submit, and retrieve certificate requests**, making it essential for **PKI (Public Key Infrastructure) operations**.*

*Because it is a **trusted Windows binary**, attackers can **abuse it** for **persistence, privilege escalation, and lateral movement** within an enterprise environment.*

## Legitimate Usage
- **Request Certificates from a CA** → Generate and submit certificate requests to an internal CA.
- **Enroll Machines or Users in PKI** → Obtain authentication certificates for secure access.
- **Renew or Manage Certificates** → Handle certificate renewals for encryption and signing.
- **Retrieve Certificates for Secure Communication** → Configure HTTPS, VPNs, and encrypted emails.

## How to abuse it
- **Abusing AD CS for Authentication** → Attackers can request machine/user certificates to **impersonate users**.
- **Persistence via Malicious Certificates** → Generate certificates for stealthy authentication.
- **Lateral Movement with Stolen Certificates** → Authenticate to services or RDP without needing passwords.
- **Bypassing MFA & Kerberos Constraints** → Use certificate-based authentication to **bypass MFA and NTLM restrictions**.

## Example Attacks
### 1. Request a Machine Certificate for Persistence
*Attackers with local admin privileges can enroll for a machine certificate, which allows stealthy persistence.*

```
certreq -new request.inf machineCert.req certreq -submit -config "CA_SERVER\CA_NAME" machineCert.req machineCert.cer certreq -accept machineCert.cer
```

**Effect:**
- Requests a **new machine certificate**.
- Submits it to the **CA for approval**.
- **Accepts and installs the certificate** for later abuse.

### 2. Request a Certificate for User Impersonation
*Attackers can enroll for a certificate and use it for pass-the-cert attacks.*

```
certreq -new userRequest.inf userCert.req certreq -submit -config "CA_SERVER\CA_NAME" userCert.req userCert.cer certreq -accept userCert.cer
```

**Effect:**
- Obtains a **valid user certificate**, allowing authentication as that user.

### 3. Bypassing MFA Using Certificate Authentication
*Some VPNs, RDP, and other services allow certificate-based authentication. Attackers can exploit this to bypass MFA.*

```
certreq -submit -attrib "CertificateTemplate:SmartCardLogon" -config "CA_SERVER\CA_NAME" userCert.req
```

**Effect:**
- Requests a **Smart Card Logon certificate**, which can be used for authentication without MFA.

### 4. Lateral Movement with Stolen Certificates
*If an attacker steals a valid certificate, they can authenticate as the victim user.*

```
certreq -retrieve -config "CA_SERVER\CA_NAME" 1234 stolenCert.cer
```

**Effect:**
- Retrieves a **stolen certificate** from a compromised CA, enabling **lateral movement**.

### 5. Persisting with Malicious Certificates
*Attackers can install backdoor certificates for long-term stealth access.*

```
certreq -accept backdoorCert.cer
```

**Effect:**
- Installs a **malicious certificate** that can be used for persistent authentication.

## Detection & Mitigation
### Detection Methods
**Monitor Certificate Requests**
- **Event ID 4886 & 4887 (CA Certificate Issued/Denied)** → Detect suspicious certificate enrollments.
- **Event ID 4769 (Kerberos Service Ticket Request)** → Look for unusual certificate-based authentications.

**Detect Certificate-Based Authentication Abuse**
- **Monitor authentication logs for Smart Card logins** (Event ID 4624, Logon Type 2 or 10).
- **Look for abnormal cert requests using ```certreq.exe``` in EDR logs**.

**Check for Unauthorized Certificates**
- **List installed certs using**: ```certutil -store -user MY```
- **Look for unexpected certificates under** ```C:\Users\*\AppData\Roaming\Microsoft\SystemCertificates\My\Certificates\```.

### Mitigation Strategies
- **Restrict Certificate Enrollment** → Limit access to AD CS and enforce strict certificate policies.
- **Monitor & Audit Certificate Requests** → Regularly review issued certificates.
- **Disable Unnecessary Certificate Templates** → Prevent abuse of SmartCardLogon and MachineCert templates.
- **Revoke Suspicious Certificates** → Use ```certutil -revoke``` to disable compromised certs.
- **Enable Strong MFA Policies** → Prevent attackers from bypassing MFA with certificates.
